<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Vedic Astrology South Indian Chart</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f0e8;
  --surface: #ffffff;
  --card: #fdfaf5;
  --card2: #f0ebe0;
  --border: #d8ccb4;
  --border-bright: #b8a888;
  --gold: #8b6914;
  --gold-light: #a8821e;
  --gold-dim: #c4a44a;
  --accent: #4a6fa5;
  --accent-light: #6389bf;
  --text: #2c2416;
  --text-dim: #6b5b3e;
  --text-muted: #a8956e;
  --red: #c0392b;
  --green: #27ae60;
  --sun: #f39c12;
  --moon: #7f8c8d;
  --mars: #c0392b;
  --mercury: #27ae60;
  --jupiter: #e67e22;
  --venus: #e91e8c;
  --saturn: #5c6bc0;
  --rahu: #607d8b;
  --ketu: #795548;
  --shadow: 0 2px 16px rgba(139,105,20,0.12);
  --glow: 0 0 0 1px rgba(184,168,136,0.3);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  background-image: radial-gradient(ellipse at 30% 10%, rgba(139,105,20,0.06) 0%, transparent 50%);
  color: var(--text);
  font-family: 'Crimson Pro', Georgia, serif;
  min-height: 100vh;
  padding: 20px 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  -webkit-tap-highlight-color: transparent;
  overflow-x: hidden;
}

.app-header {
  text-align: center;
  margin-bottom: 20px;
  width: 100%;
  max-width: 600px;
}
.app-title {
  font-family: 'Cinzel', serif;
  font-size: clamp(1rem, 3.5vw, 1.5rem);
  font-weight: 700;
  color: var(--gold);
  letter-spacing: 0.08em;
  line-height: 1.3;
}
.app-subtitle {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-top: 4px;
  font-style: italic;
}

.app-wrap {
  width: 100%;
  max-width: 600px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.lang-row {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 8px;
}
.lang-label { font-size: 0.8rem; color: var(--text-muted); }
select#lang {
  background: var(--surface);
  color: var(--text);
  border: 1px solid var(--border-bright);
  border-radius: 6px;
  padding: 5px 10px;
  font-family: inherit;
  font-size: 0.85rem;
  cursor: pointer;
  outline: none;
}

/* Chart Grid */
.chart-wrap {
  position: relative;
  background: var(--surface);
  border: 2px solid var(--border-bright);
  border-radius: 10px;
  overflow: hidden;
  box-shadow: var(--shadow);
}

.chart-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  grid-template-rows: repeat(4, minmax(78px, 1fr));
  gap: 1px;
  background: var(--border);
  grid-template-areas:
    "pisces  aries   taurus  gemini"
    "aquarius center center  cancer"
    "capricorn center center leo"
    "sagittarius scorpio libra virgo";
  width: 100%;
}

.cell {
  background: var(--card);
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 4px;
  min-height: 78px;
  /* FIX #8: cap overflow so many planets don't blow the grid */
  overflow: hidden;
  transition: background 0.15s;
}
.cell.drop-active { background: rgba(74,111,165,0.1); outline: 2px dashed var(--accent-light); outline-offset: -2px; }

.cell[data-sign="Pisces"]      { grid-area: pisces; }
.cell[data-sign="Aries"]       { grid-area: aries; }
.cell[data-sign="Taurus"]      { grid-area: taurus; }
.cell[data-sign="Gemini"]      { grid-area: gemini; }
.cell[data-sign="Aquarius"]    { grid-area: aquarius; }
.cell[data-sign="Cancer"]      { grid-area: cancer; }
.cell[data-sign="Capricorn"]   { grid-area: capricorn; }
.cell[data-sign="Leo"]         { grid-area: leo; }
.cell[data-sign="Sagittarius"] { grid-area: sagittarius; }
.cell[data-sign="Scorpio"]     { grid-area: scorpio; }
.cell[data-sign="Libra"]       { grid-area: libra; }
.cell[data-sign="Virgo"]       { grid-area: virgo; }

.cell-center {
  grid-area: center;
  background: var(--card2);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  border: none;
}
.center-line {
  font-family: 'Cinzel', serif;
  font-size: 0.62rem;
  color: var(--text-muted);
  letter-spacing: 0.14em;
  text-transform: uppercase;
}

.yoga-badge {
  font-family: 'Cinzel', serif;
  font-size: 0.56rem;
  color: var(--gold-dim);
  background: rgba(139,105,20,0.08);
  border: 1px solid rgba(139,105,20,0.2);
  border-radius: 3px;
  padding: 1px 4px;
  margin-top: 2px;
  text-align: center;
  line-height: 1.3;
  max-width: 88px;
}
.yoga-badge.detected { color: var(--gold); border-color: rgba(139,105,20,0.45); background: rgba(139,105,20,0.12); }

.sign-abbr {
  position: absolute;
  top: 3px;
  left: 4px;
  font-family: 'Cinzel', serif;
  font-size: 0.6rem;
  font-weight: 600;
  color: var(--text-muted);
  background: rgba(139,105,20,0.07);
  padding: 1px 4px;
  border-radius: 3px;
  letter-spacing: 0.04em;
  cursor: pointer;
  /* FIX #12: keyboard accessible */
  z-index: 2;
  user-select: none;
  transition: background 0.15s, color 0.15s;
}
.sign-abbr:hover { color: var(--gold); background: rgba(139,105,20,0.15); }
/* FIX #12: visible focus ring */
.sign-abbr:focus-visible { outline: 2px solid var(--gold); outline-offset: 1px; border-radius: 3px; }
.sign-abbr.hidden-label { visibility: hidden; }

.house-num {
  position: absolute;
  bottom: 3px;
  right: 4px;
  font-family: 'Cinzel', serif;
  font-size: 0.6rem;
  color: var(--accent);
  font-weight: 700;
  opacity: 0.75;
  z-index: 2;
}
.house-num.hidden-label { visibility: hidden; }

.planets-area {
  display: flex;
  flex-wrap: wrap;
  gap: 2px;
  justify-content: center;
  align-items: flex-start;
  align-content: flex-start;
  width: 100%;
  min-height: 28px;
  margin-top: 20px;
  padding: 2px;
  /* FIX #8: prevent overflow breaking grid */
  overflow: hidden;
  max-height: calc(100% - 24px);
}

/* FIX #8: overflow indicator when cell is crowded */
.cell.overcrowded::after {
  content: '‚Ä¶';
  position: absolute;
  bottom: 14px;
  right: 4px;
  font-size: 0.65rem;
  color: var(--text-muted);
  pointer-events: none;
}

/* Planet Chips */
.planet {
  display: inline-flex;
  align-items: center;
  gap: 2px;
  padding: 3px 7px;
  border-radius: 5px;
  font-family: 'Cinzel', serif;
  font-size: 0.68rem;
  font-weight: 600;
  cursor: pointer;
  user-select: none;
  white-space: nowrap;
  transition: transform 0.12s, box-shadow 0.12s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.18);
  position: relative;
  touch-action: none;
  -webkit-touch-callout: none;
  min-width: 34px;
  justify-content: center;
  z-index: 3;
  color: #fff;
  /* FIX #12: keyboard accessible */
  outline: none;
}
/* FIX #12: planet focus ring */
.planet:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }
.planet:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.22); }
.planet.dragging { opacity: 0.3; }

/* FIX #13: color-blind accessible ‚Äî add shape/pattern differentiation via border styles */
.planet.Lagna {
  background: transparent !important;
  border: 2px solid var(--gold);
  color: var(--gold) !important;
  font-size: 0.63rem;
  box-shadow: 0 0 0 1px rgba(139,105,20,0.2);
}
.planet.Sun      { background: var(--sun);     border: 2px solid rgba(0,0,0,0.15); }
.planet.Moon     { background: var(--moon);    border: 2px dashed rgba(255,255,255,0.4); }
.planet.Mars     { background: var(--mars);    border: 2px solid rgba(255,255,255,0.25); }
.planet.Mercury  { background: var(--mercury); border: 2px dotted rgba(255,255,255,0.5); }
.planet.Jupiter  { background: var(--jupiter); border: 2px solid rgba(0,0,0,0.15); }
.planet.Venus    { background: var(--venus);   border: 2px dashed rgba(255,255,255,0.4); }
.planet.Saturn   { background: var(--saturn);  border: 2px dotted rgba(255,255,255,0.5); }
.planet.Rahu     { background: var(--rahu);    border: 2px solid rgba(255,255,255,0.2); }
.planet.Ketu     { background: var(--ketu);    border: 2px dashed rgba(255,255,255,0.35); }

.retro-mark {
  font-size: 0.58rem;
  color: #ffcccc;
  font-weight: 900;
  line-height: 1;
  margin-left: 1px;
  vertical-align: super;
}
.planet.Lagna .retro-mark { color: var(--red); }

.deg-label {
  font-size: 0.55rem;
  opacity: 0.85;
  font-family: 'Crimson Pro', serif;
  font-weight: 400;
}

#drag-ghost {
  position: fixed;
  pointer-events: none;
  z-index: 9999;
  opacity: 0.85;
  transform: scale(1.1);
  display: none;
}

/* Controls Panel */
.panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 14px;
  box-shadow: var(--shadow);
}
.panel-title {
  font-family: 'Cinzel', serif;
  font-size: 0.72rem;
  font-weight: 600;
  color: var(--text-muted);
  letter-spacing: 0.12em;
  text-transform: uppercase;
  margin-bottom: 10px;
}
.planet-bank {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  justify-content: center;
  min-height: 40px;
  padding: 8px;
  background: var(--card2);
  border: 1px dashed var(--border-bright);
  border-radius: 8px;
  margin-bottom: 10px;
  transition: background 0.15s, border-color 0.15s;
}
.planet-bank.drop-active {
  background: rgba(74,111,165,0.08);
  border-color: var(--accent-light);
}
.planet-bank .planet { font-size: 0.76rem; padding: 5px 10px; min-width: 42px; }

.tip-box {
  font-size: 0.78rem;
  color: var(--text-dim);
  background: rgba(139,105,20,0.05);
  border-left: 3px solid var(--gold-dim);
  padding: 7px 10px;
  border-radius: 0 6px 6px 0;
  line-height: 1.5;
  margin-top: 8px;
  font-style: italic;
}

/* FIX #15: save/restore notice */
.persist-notice {
  font-size: 0.72rem;
  color: var(--green);
  text-align: center;
  padding: 3px 0;
  font-style: italic;
  opacity: 0;
  transition: opacity 0.4s;
}
.persist-notice.show { opacity: 1; }

.btn-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-top: 10px;
}
.btn {
  padding: 7px 14px;
  font-family: 'Cinzel', serif;
  font-size: 0.7rem;
  font-weight: 600;
  letter-spacing: 0.05em;
  border: 1px solid var(--border-bright);
  background: var(--surface);
  color: var(--text-dim);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.15s;
  text-transform: uppercase;
}
.btn:hover { background: var(--card2); color: var(--text); border-color: var(--gold-dim); }
/* FIX #12: button focus rings */
.btn:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }
.btn.danger { border-color: rgba(192,57,43,0.35); color: var(--red); }
.btn.danger:hover { background: rgba(192,57,43,0.07); }

.deg-hint {
  font-size: 0.7rem;
  color: var(--text-muted);
  text-align: center;
  padding: 4px;
  font-style: italic;
}

/* Aspect note box */
.aspect-system-note {
  font-size: 0.72rem;
  color: var(--text-muted);
  background: rgba(139,105,20,0.05);
  border-left: 3px solid var(--gold-dim);
  padding: 5px 10px;
  border-radius: 0 5px 5px 0;
  margin-bottom: 8px;
  font-style: italic;
  line-height: 1.45;
}

/* Yoga Cards */
.yogas-panel {
  display: none;
  flex-direction: column;
  gap: 6px;
}
.yogas-panel.visible { display: flex; }
.yoga-card {
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 12px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  animation: fadeIn 0.25s ease;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(3px); } to { opacity: 1; transform: none; } }
.yoga-icon { font-size: 1.1rem; flex-shrink: 0; margin-top: 1px; }
.yoga-name {
  font-family: 'Cinzel', serif;
  font-size: 0.72rem;
  color: var(--gold);
  font-weight: 600;
  margin-bottom: 2px;
}
.yoga-desc { font-size: 0.78rem; color: var(--text-dim); line-height: 1.4; }
.yoga-empty {
  font-size: 0.8rem;
  color: var(--text-muted);
  text-align: center;
  padding: 10px;
  font-style: italic;
}

/* AI Prompt Panel */
.prompt-panel {
  display: none;
  flex-direction: column;
  gap: 10px;
}
.prompt-panel.visible { display: flex; }

.prompt-output {
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  font-size: 0.78rem;
  line-height: 1.65;
  color: var(--text);
  white-space: pre-wrap;
  word-break: break-word;
  max-height: 300px;
  overflow-y: auto;
  font-family: 'Crimson Pro', serif;
}
.prompt-output:empty::before {
  content: 'Place Lagna and planets in the chart to generate a prompt‚Ä¶';
  color: var(--text-muted);
  font-style: italic;
}

.copy-toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(60px);
  background: rgba(39,174,96,0.95);
  color: #fff;
  font-family: 'Cinzel', serif;
  font-size: 0.76rem;
  letter-spacing: 0.08em;
  padding: 9px 20px;
  border-radius: 24px;
  box-shadow: 0 4px 18px rgba(0,0,0,0.2);
  z-index: 9999;
  transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1), opacity 0.3s;
  opacity: 0;
  pointer-events: none;
}
.copy-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* Tabs */
.tab-row {
  display: flex;
  gap: 0;
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}
.tab-btn {
  flex: 1;
  padding: 8px 6px;
  font-family: 'Cinzel', serif;
  font-size: 0.67rem;
  font-weight: 600;
  letter-spacing: 0.04em;
  border: none;
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.15s;
  text-transform: uppercase;
  border-right: 1px solid var(--border);
}
.tab-btn:last-child { border-right: none; }
.tab-btn.active { background: var(--surface); color: var(--gold); }
.tab-btn:hover:not(.active) { background: rgba(139,105,20,0.05); color: var(--text-dim); }
/* FIX #12: tab focus ring */
.tab-btn:focus-visible { outline: 2px solid var(--gold); outline-offset: -2px; }

.tab-content { display: none; }
.tab-content.active { display: block; }

/* Floating Tooltip */
.tooltip {
  position: fixed;
  background: rgba(255,252,245,0.98);
  border: 1px solid var(--border-bright);
  border-radius: 8px;
  padding: 10px 13px;
  font-size: 0.8rem;
  line-height: 1.6;
  color: var(--text);
  z-index: 5000;
  pointer-events: none;
  max-width: 270px;
  box-shadow: 0 6px 24px rgba(139,105,20,0.18);
  backdrop-filter: blur(4px);
  display: none;
}
.tooltip.visible { display: block; }
.tooltip strong { color: var(--gold); font-family: 'Cinzel', serif; font-size: 0.76rem; }
.tooltip hr { border: none; border-top: 1px solid var(--border); margin: 5px 0; }
.tooltip .trow { display: block; margin-bottom: 1px; }
.tooltip .trow span { color: var(--text-muted); }

/* Retrograde Panel */
.retro-panel {
  position: fixed;
  background: rgba(255,252,245,0.99);
  border: 1px solid var(--gold-dim);
  border-radius: 10px;
  padding: 14px;
  z-index: 5000;
  box-shadow: 0 6px 28px rgba(139,105,20,0.2);
  display: none;
  flex-direction: column;
  gap: 10px;
  min-width: 185px;
}
.retro-panel.visible { display: flex; }
.retro-panel-title { font-family: 'Cinzel', serif; font-size: 0.76rem; color: var(--gold); font-weight: 700; border-bottom: 1px solid var(--border); padding-bottom: 6px; }
.retro-panel label { display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.85rem; color: var(--text); }
.retro-panel input[type=checkbox] { width: 17px; height: 17px; accent-color: var(--gold); cursor: pointer; }

.deg-input-row {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.82rem;
  color: var(--text-dim);
}
.deg-input-row input[type=number] {
  width: 68px;
  background: var(--card2);
  border: 1px solid var(--border-bright);
  border-radius: 5px;
  color: var(--text);
  padding: 4px 8px;
  font-family: 'Crimson Pro', serif;
  font-size: 0.88rem;
  outline: none;
}
.deg-input-row input[type=number]:focus { border-color: var(--gold-dim); }

.retro-panel-close { align-self: flex-end; font-size: 0.68rem; color: var(--text-muted); cursor: pointer; padding: 2px 8px; border: 1px solid var(--border); border-radius: 4px; font-family: 'Cinzel', serif; }
.retro-panel-close:hover { color: var(--text); }

/* Sign Panel */
.sign-panel {
  position: fixed;
  background: rgba(255,252,245,0.99);
  border: 1px solid var(--border-bright);
  border-radius: 10px;
  padding: 12px 14px;
  z-index: 5000;
  box-shadow: 0 6px 24px rgba(139,105,20,0.15);
  display: none;
  flex-direction: column;
  gap: 4px;
  max-width: 255px;
  font-size: 0.8rem;
  line-height: 1.55;
}
.sign-panel.visible { display: flex; }
.sign-panel strong { color: var(--gold); font-family: 'Cinzel', serif; font-size: 0.76rem; }
.sign-panel hr { border: none; border-top: 1px solid var(--border); margin: 4px 0; }
.sign-panel .sp-close { align-self: flex-end; font-size: 0.68rem; color: var(--text-muted); cursor: pointer; padding: 2px 8px; border: 1px solid var(--border); border-radius: 4px; font-family: 'Cinzel', serif; }
.sign-panel .sp-close:hover { color: var(--text); }

.overlay { position: fixed; inset: 0; z-index: 4999; display: none; }
.overlay.visible { display: block; }

/* Aspects */
.aspect-entry {
  margin-bottom: 6px;
  padding: 7px 10px;
  background: var(--card2);
  border-radius: 6px;
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.78rem;
}

@media (max-width: 480px) {
  body { padding: 10px; }
  .chart-grid { grid-template-rows: repeat(4, minmax(68px, 1fr)); }
  .cell { min-height: 68px; }
  .planet { font-size: 0.6rem; padding: 2px 5px; min-width: 28px; }
  .planet-bank .planet { font-size: 0.7rem; padding: 4px 9px; }
  .sign-abbr { font-size: 0.54rem; }
  .house-num { font-size: 0.54rem; }
  .tab-btn { font-size: 0.59rem; padding: 7px 3px; }
}
</style>
</head>
<body>

<div id="drag-ghost" aria-hidden="true"></div>
<div class="overlay" id="overlay"></div>
<div class="copy-toast" id="copyToast" role="status" aria-live="polite">‚úì Copied to clipboard!</div>

<div class="app-header">
  <div class="app-title" id="appTitle">South Indian Vedic Astrology Chart</div>
  <div class="app-subtitle" id="appSubtitle">Interactive ‚Ä¢ Drag planets into signs</div>
</div>

<div class="app-wrap">

  <div class="lang-row">
    <span class="lang-label">Language:</span>
    <select id="lang" aria-label="Select language">
      <option value="en">English</option>
      <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
    </select>
  </div>

  <!-- Chart -->
  <div class="chart-wrap" role="region" aria-label="Vedic chart grid">
    <div class="chart-grid" id="chartGrid">
      <div class="cell" data-sign="Pisces">
        <span class="sign-abbr" data-sign="Pisces" tabindex="0" role="button" aria-label="Pisces sign info">Pi</span>
        <span class="house-num" aria-hidden="true"></span>
        <div class="planets-area" data-sign="Pisces" role="list" aria-label="Pisces planets"></div>
      </div>
      <div class="cell" data-sign="Aries">
        <span class="sign-abbr" data-sign="Aries" tabindex="0" role="button" aria-label="Aries sign info">Ar</span>
        <span class="house-num" aria-hidden="true"></span>
        <div class="planets-area" data-sign="Aries" role="list" aria-label="Aries planets"></div>
      </div>
      <div class="cell" data-sign="Taurus">
        <span class="sign-abbr" data-sign="Taurus" tabindex="0" role="button" aria-label="Taurus sign info">Ta</span>
        <span class="house-num" aria-hidden="true"></span>
        <div class="planets-area" data-sign="Taurus" role="list" aria-label="Taurus planets"></div>
      </div>
      <div class="cell" data-sign="Gemini">
        <span class="sign-abbr" data-sign="Gemini" tabindex="0" role="button" aria-label="Gemini sign info">Ge</span>
        <span class="house-num" aria-hidden="true"></span>
        <div class="planets-area" data-sign="Gemini" role="list" aria-label="Gemini planets"></div>
      </div>
      <div class="cell" data-sign="Aquarius">
        <span class="sign-abbr" data-sign="Aquarius" tabindex="0" role="button" aria-label="Aquarius sign info">Aq</span>
        <span class="house-num" aria-hidden="true"></span>
        <div class="planets-area" data-sign="Aquarius" role="list" aria-label="Aquarius planets"></div>
      </div>
      <div class="cell-center" id="centerCell" aria-hidden="true">
        <span class="center-line" id="centerLine1">South Indian</span>
        <span class="center-line" id="centerLine2">Chart</span>
        <div id="yogaBadgeArea"></div>
      </div>
      <div class="cell" data-sign="Cancer">
        <span class="sign-abbr" data-sign="Cancer" tabindex="0" role="button" aria-label="Cancer sign info">Cn</span>
        <span class="house-num" aria-hidden="true"></span>
        <div class="planets-area" data-sign="Cancer" role="list" aria-label="Cancer planets"></div>
      </div>
      <div class="cell" data-sign="Capricorn">
        <span class="sign-abbr" data-sign="Capricorn" tabindex="0" role="button" aria-label="Capricorn sign info">Cp</span>
        <span class="house-num" aria-hidden="true"></span>
        <div class="planets-area" data-sign="Capricorn" role="list" aria-label="Capricorn planets"></div>
      </div>
      <div class="cell" data-sign="Leo">
        <span class="sign-abbr" data-sign="Leo" tabindex="0" role="button" aria-label="Leo sign info">Le</span>
        <span class="house-num" aria-hidden="true"></span>
        <div class="planets-area" data-sign="Leo" role="list" aria-label="Leo planets"></div>
      </div>
      <div class="cell" data-sign="Sagittarius">
        <span class="sign-abbr" data-sign="Sagittarius" tabindex="0" role="button" aria-label="Sagittarius sign info">Sg</span>
        <span class="house-num" aria-hidden="true"></span>
        <div class="planets-area" data-sign="Sagittarius" role="list" aria-label="Sagittarius planets"></div>
      </div>
      <div class="cell" data-sign="Scorpio">
        <span class="sign-abbr" data-sign="Scorpio" tabindex="0" role="button" aria-label="Scorpio sign info">Sc</span>
        <span class="house-num" aria-hidden="true"></span>
        <div class="planets-area" data-sign="Scorpio" role="list" aria-label="Scorpio planets"></div>
      </div>
      <div class="cell" data-sign="Libra">
        <span class="sign-abbr" data-sign="Libra" tabindex="0" role="button" aria-label="Libra sign info">Li</span>
        <span class="house-num" aria-hidden="true"></span>
        <div class="planets-area" data-sign="Libra" role="list" aria-label="Libra planets"></div>
      </div>
      <div class="cell" data-sign="Virgo">
        <span class="sign-abbr" data-sign="Virgo" tabindex="0" role="button" aria-label="Virgo sign info">Vi</span>
        <span class="house-num" aria-hidden="true"></span>
        <div class="planets-area" data-sign="Virgo" role="list" aria-label="Virgo planets"></div>
      </div>
    </div>
  </div>

  <!-- Planet Bank -->
  <div class="panel">
    <div class="panel-title" id="bankTitle">Planet Bank ‚Äî Drag into chart</div>
    <div class="planet-bank" id="planetBank" role="list" aria-label="Available planets">
      <span class="planet Lagna" data-pid="Lagna" tabindex="0" role="listitem" aria-label="Lagna">L</span>
      <span class="planet Sun"     data-pid="Sun"     tabindex="0" role="listitem" aria-label="Sun">Su</span>
      <span class="planet Moon"    data-pid="Moon"    tabindex="0" role="listitem" aria-label="Moon">Mo</span>
      <span class="planet Mars"    data-pid="Mars"    tabindex="0" role="listitem" aria-label="Mars">Ma</span>
      <span class="planet Mercury" data-pid="Mercury" tabindex="0" role="listitem" aria-label="Mercury">Me</span>
      <span class="planet Jupiter" data-pid="Jupiter" tabindex="0" role="listitem" aria-label="Jupiter">Ju</span>
      <span class="planet Venus"   data-pid="Venus"   tabindex="0" role="listitem" aria-label="Venus">Ve</span>
      <span class="planet Saturn"  data-pid="Saturn"  tabindex="0" role="listitem" aria-label="Saturn">Sa</span>
      <span class="planet Rahu"    data-pid="Rahu"    tabindex="0" role="listitem" aria-label="Rahu">Ra</span>
      <span class="planet Ketu"    data-pid="Ketu"    tabindex="0" role="listitem" aria-label="Ketu">Ke</span>
    </div>
    <div class="tip-box" id="bankTip">Drag planets from here into a chart sign box. Double-tap a placed planet to return it here. Tap once to set retrograde &amp; exact degree.</div>
    <div class="persist-notice" id="persistNotice">Chart auto-saved ‚úì</div>

    <div class="btn-row">
      <button class="btn" id="btnSigns">Hide Signs</button>
      <button class="btn" id="btnNums">Hide Numbers</button>
      <button class="btn danger" id="btnClear">Clear Chart</button>
    </div>
    <div class="deg-hint" id="degHint">Tap placed planet ‚Üí set exact degree &amp; retrograde</div>
  </div>

  <!-- Bottom Panels: Tabs -->
  <div class="panel">
    <div class="tab-row" role="tablist" aria-label="Chart analysis panels">
      <button class="tab-btn active" data-tab="yogas"   id="tabYogas"   role="tab" aria-selected="true"  aria-controls="tab-yogas">‚ö° Yogas</button>
      <button class="tab-btn"        data-tab="prompt"  id="tabPrompt"  role="tab" aria-selected="false" aria-controls="tab-prompt">ü§ñ AI Prompt</button>
      <button class="tab-btn"        data-tab="aspects" id="tabAspects" role="tab" aria-selected="false" aria-controls="tab-aspects">üî≠ Aspects</button>
    </div>

    <!-- Tab: Yogas -->
    <div class="tab-content active" id="tab-yogas" role="tabpanel" aria-labelledby="tabYogas" style="margin-top:12px">
      <div class="yogas-panel visible" id="yogasPanel">
        <div class="yoga-empty" id="yogaEmpty">Place planets in the chart to detect yogas</div>
      </div>
    </div>

    <!-- Tab: AI Prompt -->
    <div class="tab-content" id="tab-prompt" role="tabpanel" aria-labelledby="tabPrompt" style="margin-top:12px">
      <div class="prompt-panel visible" id="promptPanel">
        <div style="font-size:0.78rem;color:var(--text-dim);line-height:1.5;font-style:italic" id="promptIntro">
          Generate a ready-to-paste prompt for any AI (ChatGPT, Claude, Gemini‚Ä¶) to get a Vedic reading.
        </div>
        <div class="prompt-output" id="promptOutput" role="region" aria-label="Generated AI prompt" aria-live="polite"></div>
        <div class="btn-row">
          <button class="btn" id="btnGenPrompt">‚ú® Generate Prompt</button>
          <button class="btn" id="btnCopyPrompt">üìã Copy</button>
        </div>
      </div>
    </div>

    <!-- Tab: Aspects -->
    <div class="tab-content" id="tab-aspects" role="tabpanel" aria-labelledby="tabAspects" style="margin-top:12px">
      <!-- FIX #7: clarify which aspect system is used -->
      <div class="aspect-system-note">
        Showing <strong>Parashari special aspects</strong> only (Mars: 4th/8th, Jupiter: 5th/9th, Saturn: 3rd/10th).
        Note: Rahu &amp; Ketu aspects vary by tradition ‚Äî Krishnamurti system is used here (5th/7th/9th).
      </div>
      <div id="aspectsPanel" style="font-size:0.8rem;line-height:1.6;color:var(--text-dim)">
        <div class="yoga-empty">Place planets in the chart to see special aspects (drishti)</div>
      </div>
    </div>

  </div>

</div>

<!-- Floating Tooltip -->
<div class="tooltip" id="tooltip" role="tooltip" aria-live="polite"></div>

<!-- Retrograde + Degree panel -->
<div class="retro-panel" id="retroPanel" role="dialog" aria-modal="true" aria-labelledby="retroTitle">
  <div class="retro-panel-title" id="retroTitle">Planet</div>
  <label>
    <input type="checkbox" id="retroCheck" aria-label="Mark as retrograde">
    <span id="retroLabel">Retrograde</span>
  </label>
  <div class="deg-input-row">
    <label for="degInput">Degree:</label>
    <input type="number" id="degInput" min="0" max="29.99" step="0.1" value="0"
           aria-label="Planet degree within sign">
    <span>¬∞</span>
  </div>
  <span class="retro-panel-close" id="retroClose" tabindex="0" role="button">Close</span>
</div>

<!-- Sign info panel -->
<div class="sign-panel" id="signPanel" role="dialog" aria-modal="true" aria-labelledby="spSignName">
  <strong id="spSignName"></strong>
  <hr>
  <div id="spBody"></div>
  <span class="sp-close" id="spClose" tabindex="0" role="button">Close</span>
</div>

<script>
/* ‚îÄ‚îÄ‚îÄ Static Data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const SIGNS = ["Aries","Taurus","Gemini","Cancer","Leo","Virgo","Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"];
const ALL_PIDS = ['Lagna','Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn','Rahu','Ketu'];

const NAKSH = [
  {name:'Ashwini',   lord:'Ketu',    kw:'Speed, Healing, Initiative'},
  {name:'Bharani',   lord:'Venus',   kw:'Transformation, Patience, Sacrifice'},
  {name:'Krittika',  lord:'Sun',     kw:'Purification, Leadership, Protection'},
  {name:'Rohini',    lord:'Moon',    kw:'Growth, Fertility, Creativity'},
  {name:'Mrigashira',lord:'Mars',    kw:'Curiosity, Searching, Wandering'},
  {name:'Ardra',     lord:'Rahu',    kw:'Transformation, Intensity, Renewal'},
  {name:'Punarvasu', lord:'Jupiter', kw:'Renewal, Nourishment, Return'},
  {name:'Pushya',    lord:'Saturn',  kw:'Nourishment, Protection, Spirituality'},
  {name:'Ashlesha',  lord:'Mercury', kw:'Intuition, Hypnotic, Mysticism'},
  {name:'Magha',     lord:'Ketu',    kw:'Authority, Ancestors, Legacy'},
  {name:'Purva Phalguni',  lord:'Venus',   kw:'Enjoyment, Luxury, Romance'},
  {name:'Uttara Phalguni', lord:'Sun',     kw:'Support, Union, Philanthropy'},
  {name:'Hasta',     lord:'Moon',    kw:'Skill, Dexterity, Craftsmanship'},
  {name:'Chitra',    lord:'Mars',    kw:'Artistry, Beauty, Architecture'},
  {name:'Swati',     lord:'Rahu',    kw:'Independence, Movement, Adaptability'},
  {name:'Vishakha',  lord:'Jupiter', kw:'Purpose, Determination, Achievement'},
  {name:'Anuradha',  lord:'Saturn',  kw:'Devotion, Friendship, Success'},
  {name:'Jyeshtha',  lord:'Mercury', kw:'Seniority, Protection, Power'},
  {name:'Moola',     lord:'Ketu',    kw:'Foundation, Destruction, Research'},
  {name:'Purva Ashadha',   lord:'Venus',   kw:'Invincibility, Persistence, Water'},
  {name:'Uttara Ashadha',  lord:'Sun',     kw:'Victory, Dharma, Leadership'},
  {name:'Shravana',  lord:'Moon',    kw:'Listening, Learning, Wisdom'},
  {name:'Dhanishta', lord:'Mars',    kw:'Wealth, Rhythm, Celebration'},
  {name:'Shatabhisha',lord:'Rahu',   kw:'Healing, Mysticism, Hidden Knowledge'},
  {name:'Purva Bhadrapada',lord:'Jupiter', kw:'Transformation, Spiritual Fire'},
  {name:'Uttara Bhadrapada',lord:'Saturn', kw:'Stability, Prosperity, Universal Love'},
  {name:'Revati',    lord:'Mercury', kw:'Nourishment, Protection, Completion'}
];

const PLANET_RULES = {
  Sun:['Leo'], Moon:['Cancer'], Mars:['Aries','Scorpio'],
  Mercury:['Gemini','Virgo'], Jupiter:['Sagittarius','Pisces'],
  Venus:['Taurus','Libra'], Saturn:['Capricorn','Aquarius'],
  Rahu:['Aquarius'], Ketu:['Scorpio']
};

const EXALTATION = {
  Sun:'Aries', Moon:'Taurus', Mars:'Capricorn',
  Mercury:'Virgo', Jupiter:'Cancer', Venus:'Pisces',
  Saturn:'Libra', Rahu:'Taurus', Ketu:'Scorpio'
};
const DEBILITATION = {
  Sun:'Libra', Moon:'Scorpio', Mars:'Cancer',
  Mercury:'Pisces', Jupiter:'Capricorn', Venus:'Virgo',
  Saturn:'Aries', Rahu:'Scorpio', Ketu:'Taurus'
};

const SIGN_DATA = {
  Aries:      {kw:'Initiation, Action, Energy',               ruler:'Mars',         el:'Fire',  mod:'Cardinal', symbol:'‚ôà'},
  Taurus:     {kw:'Stability, Sensuality, Comfort',           ruler:'Venus',        el:'Earth', mod:'Fixed',    symbol:'‚ôâ'},
  Gemini:     {kw:'Communication, Intellect, Versatility',    ruler:'Mercury',      el:'Air',   mod:'Dual',     symbol:'‚ôä'},
  Cancer:     {kw:'Nurturing, Emotion, Home',                 ruler:'Moon',         el:'Water', mod:'Cardinal', symbol:'‚ôã'},
  Leo:        {kw:'Creativity, Leadership, Royalty',          ruler:'Sun',          el:'Fire',  mod:'Fixed',    symbol:'‚ôå'},
  Virgo:      {kw:'Service, Analysis, Health',                ruler:'Mercury',      el:'Earth', mod:'Dual',     symbol:'‚ôç'},
  Libra:      {kw:'Harmony, Relationships, Justice',          ruler:'Venus',        el:'Air',   mod:'Cardinal', symbol:'‚ôé'},
  Scorpio:    {kw:'Transformation, Secrecy, Intensity',       ruler:'Mars, Ketu',   el:'Water', mod:'Fixed',    symbol:'‚ôè'},
  Sagittarius:{kw:'Philosophy, Exploration, Wisdom',          ruler:'Jupiter',      el:'Fire',  mod:'Dual',     symbol:'‚ôê'},
  Capricorn:  {kw:'Discipline, Ambition, Structure',          ruler:'Saturn',       el:'Earth', mod:'Cardinal', symbol:'‚ôë'},
  Aquarius:   {kw:'Innovation, Humanitarianism',              ruler:'Saturn, Rahu', el:'Air',   mod:'Fixed',    symbol:'‚ôí'},
  Pisces:     {kw:'Imagination, Spirituality, Compassion',    ruler:'Jupiter, Ketu',el:'Water', mod:'Dual',     symbol:'‚ôì'}
};

const HOUSE_KW = {
  1:'Self, Personality, Body, Appearance, Health',
  2:'Wealth, Family, Speech, Food, Values',
  3:'Siblings, Courage, Communication, Skills',
  4:'Mother, Home, Land, Vehicles, Inner Peace',
  5:'Children, Creativity, Intelligence, Romance',
  6:'Enemies, Debts, Disease, Service, Obstacles',
  7:'Marriage, Partnerships, Business, Spouse',
  8:'Longevity, Occult, Inheritance, Transformation',
  9:'Father, Guru, Dharma, Fortune, Spirituality',
  10:'Career, Status, Reputation, Authority',
  11:'Gains, Friends, Hopes, Community, Ambitions',
  12:'Losses, Expenses, Moksha, Foreign Lands'
};

// FIX #7: Documented which aspect system (Krishnamurti for Rahu/Ketu)
const SPECIAL_ASPECTS = {
  Mars:    [4, 7, 8],
  Jupiter: [5, 7, 9],
  Saturn:  [3, 7, 10],
  Rahu:    [5, 7, 9],  // Krishnamurti system
  Ketu:    [5, 7, 9]   // Krishnamurti system
};

const YOGA_DEFS = [
  {
    name:'Gaja Kesari Yoga', icon:'üêò',
    desc:'Jupiter and Moon in mutual kendra (1,4,7,10). Brings wisdom, fame, and prosperity.',
    check: (pd, ls) => {
      if (!ls || !pd['Jupiter'] || !pd['Moon']) return false;
      const jH = houseNum(pd['Jupiter'].sign, ls);
      const mH = houseNum(pd['Moon'].sign, ls);
      if (!jH || !mH) return false;
      return [0,3,6,9].includes(Math.abs(jH - mH));
    }
  },
  {
    name:'Budha-Aditya Yoga', icon:'‚òÄÔ∏è',
    desc:'Sun and Mercury conjunct. Enhances intelligence, communication, and fame.',
    check: (pd) => !!(pd['Sun'] && pd['Mercury'] && pd['Sun'].sign === pd['Mercury'].sign)
  },
  {
    name:'Chandra-Mangal Yoga', icon:'üåô',
    desc:'Moon and Mars conjunct. Strong willpower, financial acumen, emotional courage.',
    check: (pd) => !!(pd['Moon'] && pd['Mars'] && pd['Moon'].sign === pd['Mars'].sign)
  },
  {
    name:'Lakshmi Yoga', icon:'ü™∑',
    desc:'Venus in kendra/trikona in own sign or exaltation. Wealth and grace.',
    check: (pd, ls) => {
      if (!ls || !pd['Venus']) return false;
      const vH = houseNum(pd['Venus'].sign, ls);
      if (!vH) return false;
      const exalt = EXALTATION['Venus'] === pd['Venus'].sign;
      const own = (PLANET_RULES['Venus'] || []).includes(pd['Venus'].sign);
      return [1,4,5,7,9,10].includes(vH) && (exalt || own);
    }
  },
  {
    name:'Hamsa Yoga', icon:'üïäÔ∏è',
    desc:'Jupiter in own sign or exaltation in a kendra. Pure soul and dharmic path.',
    check: (pd, ls) => {
      if (!ls || !pd['Jupiter']) return false;
      const jH = houseNum(pd['Jupiter'].sign, ls);
      if (!jH) return false;
      const exalt = EXALTATION['Jupiter'] === pd['Jupiter'].sign;
      const own = (PLANET_RULES['Jupiter'] || []).includes(pd['Jupiter'].sign);
      return [1,4,7,10].includes(jH) && (exalt || own);
    }
  },
  {
    name:'Malavya Yoga', icon:'üíé',
    desc:'Venus in own sign or exaltation in a kendra. Luxury and artistic talent.',
    check: (pd, ls) => {
      if (!ls || !pd['Venus']) return false;
      const vH = houseNum(pd['Venus'].sign, ls);
      if (!vH) return false;
      const exalt = EXALTATION['Venus'] === pd['Venus'].sign;
      const own = (PLANET_RULES['Venus'] || []).includes(pd['Venus'].sign);
      return [1,4,7,10].includes(vH) && (exalt || own);
    }
  },
  {
    name:'Sasa Yoga', icon:'ü™ê',
    desc:'Saturn in own sign or exaltation in a kendra. Discipline and longevity.',
    check: (pd, ls) => {
      if (!ls || !pd['Saturn']) return false;
      const sH = houseNum(pd['Saturn'].sign, ls);
      if (!sH) return false;
      const exalt = EXALTATION['Saturn'] === pd['Saturn'].sign;
      const own = (PLANET_RULES['Saturn'] || []).includes(pd['Saturn'].sign);
      return [1,4,7,10].includes(sH) && (exalt || own);
    }
  },
  {
    name:'Ruchaka Yoga', icon:'‚öîÔ∏è',
    desc:'Mars in own sign or exaltation in a kendra. Courage and physical authority.',
    check: (pd, ls) => {
      if (!ls || !pd['Mars']) return false;
      const mH = houseNum(pd['Mars'].sign, ls);
      if (!mH) return false;
      const exalt = EXALTATION['Mars'] === pd['Mars'].sign;
      const own = (PLANET_RULES['Mars'] || []).includes(pd['Mars'].sign);
      return [1,4,7,10].includes(mH) && (exalt || own);
    }
  },
  {
    name:'Kemadruma Yoga', icon:'‚ö†Ô∏è',
    desc:'Moon isolated ‚Äî no planets in 2nd or 12th from it. Challenges and hardship.',
    check: (pd) => {
      if (!pd['Moon']) return false;
      const moonIdx = SIGNS.indexOf(pd['Moon'].sign);
      const prev = SIGNS[(moonIdx - 1 + 12) % 12];
      const next = SIGNS[(moonIdx + 1) % 12];
      const pids = ['Sun','Mars','Mercury','Jupiter','Venus','Saturn'];
      // FIX #5: safe null guard before accessing .sign
      return !pids.some(p => {
        const d = pd[p];
        return d && (d.sign === prev || d.sign === next || d.sign === pd['Moon'].sign);
      });
    }
  }
];

const TRANS = {
  en: {
    title:'South Indian Vedic Astrology Chart',
    subtitle:'Interactive ‚Ä¢ Drag planets into signs',
    bankTitle:'Planet Bank ‚Äî Drag into chart',
    bankTip:'Drag a planet into a sign. Tap once to set degree & retrograde. Double-tap to return to bank.',
    degHint:'Tap placed planet ‚Üí set exact degree & retrograde',
    hideSigns:'Hide Signs', showSigns:'Show Signs',
    hideNums:'Hide Numbers', showNums:'Show Numbers',
    clearChart:'Clear Chart',
    retroLabel:'Retrograde', close:'Close',
    nakshatra:'Nakshatra', pada:'Pada', house:'House',
    houseKw:'House Keywords', signKw:'Sign Keywords',
    ruler:'Ruler', element:'Element', modality:'Modality',
    lordOf:'Lord of', houseLord:'House Lordship',
    noLagna:'(Place Lagna to see house info)',
    center1:'South Indian', center2:'Chart',
    exalted:'Exalted', debilitated:'Debil.', ownSign:'Own',
    pnames:{Lagna:'Lagna',Sun:'Sun',Moon:'Moon',Mars:'Mars',Mercury:'Mercury',Jupiter:'Jupiter',Venus:'Venus',Saturn:'Saturn',Rahu:'Rahu',Ketu:'Ketu'},
    psym:{Lagna:'L',Sun:'Su',Moon:'Mo',Mars:'Ma',Mercury:'Me',Jupiter:'Ju',Venus:'Ve',Saturn:'Sa',Rahu:'Ra',Ketu:'Ke'},
    snames:{Aries:'Aries',Taurus:'Taurus',Gemini:'Gemini',Cancer:'Cancer',Leo:'Leo',Virgo:'Virgo',Libra:'Libra',Scorpio:'Scorpio',Sagittarius:'Sagittarius',Capricorn:'Capricorn',Aquarius:'Aquarius',Pisces:'Pisces'},
    ssym:{Aries:'Ar',Taurus:'Ta',Gemini:'Ge',Cancer:'Cn',Leo:'Le',Virgo:'Vi',Libra:'Li',Scorpio:'Sc',Sagittarius:'Sg',Capricorn:'Cp',Aquarius:'Aq',Pisces:'Pi'},
    hn:{1:'1st House',2:'2nd House',3:'3rd House',4:'4th House',5:'5th House',6:'6th House',7:'7th House',8:'8th House',9:'9th House',10:'10th House',11:'11th House',12:'12th House'}
  },
  te: {
    title:'‡∞¶‡∞ï‡±ç‡∞∑‡∞ø‡∞£ ‡∞≠‡∞æ‡∞∞‡∞§‡±Ä‡∞Ø ‡∞µ‡±á‡∞¶ ‡∞ú‡±ç‡∞Ø‡±ã‡∞§‡∞ø‡∞∑‡±ç‡∞Ø ‡∞ö‡∞æ‡∞∞‡±ç‡∞ü‡±ç',
    subtitle:'‡∞á‡∞Ç‡∞ü‡∞∞‡∞æ‡∞ï‡±ç‡∞ü‡∞ø‡∞µ‡±ç ‚Ä¢ ‡∞ó‡±ç‡∞∞‡∞π‡∞æ‡∞≤‡∞®‡±Å ‡∞∞‡∞æ‡∞∂‡±Å‡∞≤‡∞≤‡±ã ‡∞â‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø',
    bankTitle:'‡∞ó‡±ç‡∞∞‡∞π ‡∞¨‡±ç‡∞Ø‡∞æ‡∞Ç‡∞ï‡±ç ‚Äî ‡∞ö‡∞æ‡∞∞‡±ç‡∞ü‡±ç‚Äå‡∞≤‡±ã‡∞ï‡∞ø ‡∞≤‡∞æ‡∞ó‡∞Ç‡∞°‡∞ø',
    bankTip:'‡∞ó‡±ç‡∞∞‡∞π‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞∞‡∞æ‡∞∂‡∞ø‡∞≤‡±ã‡∞ï‡∞ø ‡∞≤‡∞æ‡∞ó‡∞Ç‡∞°‡∞ø. ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø ‡∞°‡∞ø‡∞ó‡±ç‡∞∞‡±Ä/‡∞µ‡∞ï‡±ç‡∞∞‡∞ø ‡∞∏‡±Ü‡∞ü‡±ç ‡∞ö‡±á‡∞Ø‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø. ‡∞∞‡±Ü‡∞Ç‡∞°‡±Å‡∞∏‡∞æ‡∞∞‡±ç‡∞≤‡±Å ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞ø ‡∞§‡∞ø‡∞∞‡∞ø‡∞ó‡∞ø ‡∞™‡∞Ç‡∞™‡∞Ç‡∞°‡∞ø.',
    degHint:'‡∞ó‡±ç‡∞∞‡∞π‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞ø ‡∞°‡∞ø‡∞ó‡±ç‡∞∞‡±Ä & ‡∞µ‡∞ï‡±ç‡∞∞‡∞ø ‡∞∏‡±Ü‡∞ü‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø',
    hideSigns:'‡∞∞‡∞æ‡∞∂‡±Å‡∞≤‡∞®‡±Å ‡∞¶‡∞æ‡∞ö‡±Å', showSigns:'‡∞∞‡∞æ‡∞∂‡±Å‡∞≤‡∞®‡±Å ‡∞ö‡±Ç‡∞™‡±Å',
    hideNums:'‡∞®‡∞Ç‡∞¨‡∞∞‡±ç‡∞≤‡∞®‡±Å ‡∞¶‡∞æ‡∞ö‡±Å', showNums:'‡∞®‡∞Ç‡∞¨‡∞∞‡±ç‡∞≤‡∞®‡±Å ‡∞ö‡±Ç‡∞™‡±Å',
    clearChart:'‡∞ö‡∞æ‡∞∞‡±ç‡∞ü‡±ç ‡∞ï‡±ç‡∞≤‡∞ø‡∞Ø‡∞∞‡±ç',
    retroLabel:'‡∞µ‡∞ï‡±ç‡∞∞‡∞ø', close:'‡∞Æ‡±Ç‡∞∏‡∞ø‡∞µ‡±á‡∞Ø‡∞ø',
    nakshatra:'‡∞®‡∞ï‡±ç‡∞∑‡∞§‡±ç‡∞∞‡∞Ç', pada:'‡∞™‡∞æ‡∞¶', house:'‡∞á‡∞≤‡±ç‡∞≤‡±Å',
    houseKw:'‡∞á‡∞Ç‡∞ü‡∞ø ‡∞ï‡±Ä‡∞µ‡∞∞‡±ç‡∞°‡±ç‡∞∏‡±ç', signKw:'‡∞∞‡∞æ‡∞∂‡∞ø ‡∞ï‡±Ä‡∞µ‡∞∞‡±ç‡∞°‡±ç‡∞∏‡±ç',
    ruler:'‡∞™‡∞æ‡∞≤‡∞ï ‡∞ó‡±ç‡∞∞‡∞π‡∞Ç', element:'‡∞Æ‡±Ç‡∞≤‡∞ï‡∞Ç', modality:'‡∞Æ‡±ã‡∞°‡∞æ‡∞≤‡∞ø‡∞ü‡±Ä',
    lordOf:'‡∞Ö‡∞ß‡∞ø‡∞™‡∞§‡∞ø', houseLord:'‡∞á‡∞Ç‡∞ü‡∞ø ‡∞Ü‡∞ß‡∞ø‡∞™‡∞§‡±ç‡∞Ø‡∞Ç',
    noLagna:'(‡∞á‡∞Ç‡∞ü‡∞ø ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç ‡∞ö‡±Ç‡∞°‡∞ü‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞≤‡∞ó‡±ç‡∞®‡∞æ‡∞®‡∞ø ‡∞â‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø)',
    center1:'‡∞¶‡∞ï‡±ç‡∞∑‡∞ø‡∞£ ‡∞≠‡∞æ‡∞∞‡∞§‡±Ä‡∞Ø', center2:'‡∞ö‡∞æ‡∞∞‡±ç‡∞ü‡±ç',
    exalted:'‡∞â‡∞ö‡±ç‡∞ö', debilitated:'‡∞®‡±Ä‡∞ö', ownSign:'‡∞∏‡±ç‡∞µ',
    // FIX #18: separate Saturn (‡∞∂‡∞®‡∞ø) and Venus (‡∞∂‡±Å‡∞ï‡±ç‡∞∞‡±Å‡∞°‡±Å) symbols clearly
    pnames:{Lagna:'‡∞≤‡∞ó‡±ç‡∞®',Sun:'‡∞∏‡±Ç‡∞∞‡±ç‡∞Ø‡±Å‡∞°‡±Å',Moon:'‡∞ö‡∞Ç‡∞¶‡±ç‡∞∞‡±Å‡∞°‡±Å',Mars:'‡∞ï‡±Å‡∞ú‡±Å‡∞°‡±Å',Mercury:'‡∞¨‡±Å‡∞ß‡±Å‡∞°‡±Å',Jupiter:'‡∞ó‡±Å‡∞∞‡±Å‡∞°‡±Å',Venus:'‡∞∂‡±Å‡∞ï‡±ç‡∞∞‡±Å‡∞°‡±Å',Saturn:'‡∞∂‡∞®‡∞ø',Rahu:'‡∞∞‡∞æ‡∞π‡±Å‡∞µ‡±Å',Ketu:'‡∞ï‡±á‡∞§‡±Å‡∞µ‡±Å'},
    psym:{Lagna:'‡∞≤',Sun:'‡∞∏‡±Ç',Moon:'‡∞ö‡∞Ç',Mars:'‡∞ï‡±Å',Mercury:'‡∞¨‡±Å',Jupiter:'‡∞ó‡±Å',Venus:'‡∞∂‡±Å‡∞ï‡±ç‡∞∞',Saturn:'‡∞∂‡∞®‡∞ø',Rahu:'‡∞∞‡∞æ',Ketu:'‡∞ï‡±á'},
    snames:{Aries:'‡∞Æ‡±á‡∞∑‡∞Ç',Taurus:'‡∞µ‡±É‡∞∑‡∞≠‡∞Ç',Gemini:'‡∞Æ‡∞ø‡∞•‡±Å‡∞®‡∞Ç',Cancer:'‡∞ï‡∞∞‡±ç‡∞ï‡∞æ‡∞ü‡∞ï‡∞Ç',Leo:'‡∞∏‡∞ø‡∞Ç‡∞π‡∞Ç',Virgo:'‡∞ï‡∞®‡±ç‡∞Ø',Libra:'‡∞§‡±Å‡∞≤',Scorpio:'‡∞µ‡±É‡∞∂‡±ç‡∞ö‡∞ø‡∞ï‡∞Ç',Sagittarius:'‡∞ß‡∞®‡±Å‡∞∏‡±ç‡∞∏‡±Å',Capricorn:'‡∞Æ‡∞ï‡∞∞‡∞Ç',Aquarius:'‡∞ï‡±Å‡∞Ç‡∞≠‡∞Ç',Pisces:'‡∞Æ‡±Ä‡∞®‡∞Ç'},
    ssym:{Aries:'‡∞Æ‡±á',Taurus:'‡∞µ‡±É',Gemini:'‡∞Æ‡∞ø',Cancer:'‡∞ï',Leo:'‡∞∏‡∞ø‡∞Ç',Virgo:'‡∞ï‡∞®‡±ç‡∞Ø',Libra:'‡∞§‡±Å',Scorpio:'‡∞µ‡±É‡∞∂‡±ç‡∞ö‡∞ø',Sagittarius:'‡∞ß‡∞®‡±Å',Capricorn:'‡∞Æ‡∞ï',Aquarius:'‡∞ï‡±Å‡∞Ç',Pisces:'‡∞Æ‡±Ä'},
    hn:{1:'1‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',2:'2‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',3:'3‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',4:'4‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',5:'5‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',6:'6‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',7:'7‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',8:'8‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',9:'9‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',10:'10‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',11:'11‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',12:'12‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å'}
  }
};

/* ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let lang = 'en';
let lagnaSign = null;
let signsHidden = false;
let numsHidden = false;
let planetData = {};
let activePlanetForRetro = null;
let dragState = null;
let lastDragEndTime = 0;

// FIX #14: debounce timer refs for expensive re-computations
let yogaDebounceTimer = null;
let aspectDebounceTimer = null;

/* ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const T = () => TRANS[lang];
function getEl(sel) { return document.querySelector(sel); }
function getAll(sel) { return document.querySelectorAll(sel); }

// FIX #4: houseNum now requires explicit lagnaSign arg; no silent global fallback
function houseNum(sign, ls) {
  if (!ls) return null;
  const a = SIGNS.indexOf(ls);
  const s = SIGNS.indexOf(sign);
  if (a < 0 || s < 0) return null;
  return (s - a + 12) % 12 + 1;
}

function getNakshatra(sign, deg) {
  const si = SIGNS.indexOf(sign);
  if (si < 0) return {name:'?', kw:'', pada:1, lord:'?'};
  const total = si * 30 + deg;
  const nLen = 360 / 27;
  let ni = Math.floor(total / nLen);
  if (ni >= 27) ni = 26;
  const inNak = total % nLen;
  const pada = Math.min(4, Math.floor(inNak / (nLen / 4)) + 1);
  return {...NAKSH[ni], pada};
}

function getStrength(pid, sign) {
  if (!pid || pid === 'Lagna') return null;
  if (EXALTATION[pid] === sign) return 'exalted';
  if (DEBILITATION[pid] === sign) return 'debilitated';
  if ((PLANET_RULES[pid] || []).includes(sign)) return 'own';
  return null;
}

/* ‚îÄ‚îÄ‚îÄ Build Planet Element ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function buildPlanet(pid) {
  const el = document.createElement('span');
  el.className = `planet ${pid}`;
  el.dataset.pid = pid;
  el.setAttribute('tabindex', '0');
  el.setAttribute('role', 'button');
  el.setAttribute('aria-label', T().pnames[pid] || pid);
  refreshPlanetContent(el);
  return el;
}

function refreshPlanetContent(el) {
  const pid = el.dataset.pid;
  const t = T();
  const sym = t.psym[pid] || pid.slice(0,2);
  const d = planetData[pid];
  let html = sym;
  if (d) {
    html += `<span class="deg-label" aria-hidden="true">${d.degree.toFixed(1)}¬∞</span>`;
    if (d.retro) html += `<span class="retro-mark" aria-label="retrograde" title="Retrograde">R</span>`;
  }
  el.innerHTML = html;
  el.setAttribute('aria-label', `${t.pnames[pid] || pid}${d ? ' ' + d.degree.toFixed(1) + ' degrees' : ''}${d?.retro ? ' retrograde' : ''}`);
}

function refreshAllPlanets() {
  document.querySelectorAll('.planet').forEach(el => refreshPlanetContent(el));
}

// FIX #17: rebuildBank is now called on init AND after any change that could desync
function rebuildBank() {
  const bank = getEl('#planetBank');
  const inChart = new Set(
    [...document.querySelectorAll('.planets-area .planet')].map(el => el.dataset.pid)
  );
  [...bank.querySelectorAll('.planet')].forEach(el => el.remove());
  ALL_PIDS.forEach(pid => {
    if (!inChart.has(pid)) bank.appendChild(buildPlanet(pid));
  });
}

/* ‚îÄ‚îÄ‚îÄ House Numbers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function updateHouseNums() {
  getAll('.cell[data-sign]').forEach(cell => {
    const hn = cell.querySelector('.house-num');
    // FIX #4: always pass lagnaSign explicitly
    const n = houseNum(cell.dataset.sign, lagnaSign);
    hn.textContent = (n && !numsHidden) ? n : '';
  });
}

/* ‚îÄ‚îÄ‚îÄ Sign Abbreviations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function updateSignLabels() {
  const t = T();
  getAll('.sign-abbr').forEach(el => {
    const sign = el.dataset.sign;
    el.textContent = t.ssym[sign] || sign.slice(0,2);
    el.classList.toggle('hidden-label', signsHidden);
    el.setAttribute('aria-label', `${t.snames[sign] || sign} sign info`);
    el.setAttribute('aria-hidden', signsHidden ? 'true' : 'false');
    if (signsHidden) el.setAttribute('tabindex', '-1');
    else el.setAttribute('tabindex', '0');
  });
}

/* ‚îÄ‚îÄ‚îÄ Overflow indicator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
// FIX #8: mark cells with too many planets
function updateOverflowIndicators() {
  getAll('.cell[data-sign]').forEach(cell => {
    const area = cell.querySelector('.planets-area');
    const count = area ? area.querySelectorAll('.planet').length : 0;
    cell.classList.toggle('overcrowded', count >= 4);
  });
}

/* ‚îÄ‚îÄ‚îÄ Yoga Detection (debounced) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
// FIX #14: debounce so rapid degree-scrubbing doesn't run detection on every frame
function scheduleYogaUpdate() {
  clearTimeout(yogaDebounceTimer);
  yogaDebounceTimer = setTimeout(detectYogas, 120);
}

function detectYogas() {
  const panel = getEl('#yogasPanel');
  panel.innerHTML = '';
  const detected = YOGA_DEFS.filter(y => {
    try { return y.check(planetData, lagnaSign); }
    catch(e) { return false; }  // FIX #5: swallow unexpected errors gracefully
  });

  if (detected.length === 0) {
    panel.innerHTML = `<div class="yoga-empty">No yogas detected yet. Place more planets in the chart.</div>`;
    getEl('#yogaBadgeArea').innerHTML = '';
    return;
  }

  detected.forEach(y => {
    const card = document.createElement('div');
    card.className = 'yoga-card';
    card.innerHTML = `<div class="yoga-icon" aria-hidden="true">${y.icon}</div>
      <div>
        <div class="yoga-name">${y.name}</div>
        <div class="yoga-desc">${y.desc}</div>
      </div>`;
    panel.appendChild(card);
  });

  const area = getEl('#yogaBadgeArea');
  area.innerHTML = `<div class="yoga-badge detected" aria-live="polite">${detected.length} Yoga${detected.length>1?'s':''}</div>`;
}

/* ‚îÄ‚îÄ‚îÄ Aspects Detection (debounced) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
// FIX #14: debounce aspects too
function scheduleAspectUpdate() {
  clearTimeout(aspectDebounceTimer);
  aspectDebounceTimer = setTimeout(updateAspects, 120);
}

function updateAspects() {
  const panel = getEl('#aspectsPanel');
  const placed = ALL_PIDS.filter(p => p !== 'Lagna' && planetData[p]);
  if (!lagnaSign || placed.length < 2) {
    panel.innerHTML = `<div class="yoga-empty">Place Lagna and planets to see special aspects (drishti)</div>`;
    return;
  }

  let html = `<div style="font-family:'Cinzel',serif;font-size:0.7rem;color:var(--text-muted);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:8px">Special Aspects (Drishti)</div>`;
  const t = T();
  let anyFound = false;

  placed.forEach(pid => {
    if (!SPECIAL_ASPECTS[pid]) return;
    const d = planetData[pid];
    // FIX #4: explicit lagnaSign
    const fromH = houseNum(d.sign, lagnaSign);
    if (!fromH) return;

    const aspectedHouses = SPECIAL_ASPECTS[pid].map(rel => ((fromH - 1 + rel - 1) % 12) + 1);
    const aspectedSigns = SIGNS.filter(s => {
      const h = houseNum(s, lagnaSign);
      return h && aspectedHouses.includes(h);
    });

    const aspectedPlanets = placed.filter(p2 => {
      // FIX #6: guard against missing data
      return p2 !== pid && planetData[p2] && aspectedSigns.includes(planetData[p2].sign);
    });

    if (aspectedPlanets.length === 0 && aspectedSigns.length > 0) {
      html += `<div class="aspect-entry">
        <span style="color:var(--text-muted);font-family:'Cinzel',serif;font-size:0.7rem">${t.pnames[pid]}</span>
        <span style="color:var(--text-muted)">aspects Houses ${aspectedHouses.join(', ')} (empty)</span>
      </div>`;
      anyFound = true;
      return;
    }

    aspectedPlanets.forEach(p2 => {
      // FIX #6: guard
      if (!planetData[p2]) return;
      const toH = houseNum(planetData[p2].sign, lagnaSign);
      html += `<div class="aspect-entry">
        <span class="planet ${pid}" style="pointer-events:none;transform:none;box-shadow:none;font-size:0.62rem;padding:2px 6px" aria-hidden="true">${t.psym[pid]}</span>
        <span style="color:var(--accent);font-size:0.85rem" aria-hidden="true">‚Üí</span>
        <span class="planet ${p2}" style="pointer-events:none;transform:none;box-shadow:none;font-size:0.62rem;padding:2px 6px" aria-hidden="true">${t.psym[p2]}</span>
        <span style="color:var(--text-dim);font-size:0.76rem">${t.pnames[pid]} aspects ${t.pnames[p2]} in H${toH}</span>
      </div>`;
      anyFound = true;
    });
  });

  if (!anyFound) html += `<div class="yoga-empty">No special aspects found between placed planets.</div>`;
  panel.innerHTML = html;
}

/* ‚îÄ‚îÄ‚îÄ AI Prompt Generator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function generatePrompt() {
  const t = T();
  const placed = ALL_PIDS.filter(p => planetData[p]);
  if (placed.length === 0) { getEl('#promptOutput').textContent = ''; return; }

  const lagnaInfo = planetData['Lagna'];
  const lagnaText = lagnaInfo
    ? `Lagna (Ascendant): ${lagnaInfo.sign} (${lagnaInfo.degree.toFixed(2)}¬∞)`
    : 'Lagna: Not placed';

  const planetLines = [];
  ALL_PIDS.filter(p => p !== 'Lagna' && planetData[p]).forEach(pid => {
    const d = planetData[pid];
    const nak = getNakshatra(d.sign, d.degree);
    // FIX #4: explicit lagnaSign
    const hn = lagnaSign ? houseNum(d.sign, lagnaSign) : null;
    const strength = getStrength(pid, d.sign);
    let line = `${t.pnames[pid]}: ${d.sign} at ${d.degree.toFixed(2)}¬∞ ‚Äî ${nak.name} Nakshatra (Pada ${nak.pada}, Lord: ${nak.lord})`;
    if (hn) line += `, ${t.hn[hn]}`;
    if (strength) line += ` [${strength === 'exalted' ? 'EXALTED' : strength === 'debilitated' ? 'DEBILITATED' : 'Own Sign'}]`;
    if (d.retro) line += ' ‚Ñû (Retrograde)';
    planetLines.push(line);
  });

  const detectedYogas = YOGA_DEFS.filter(y => {
    try { return y.check(planetData, lagnaSign); }
    catch(e) { return false; }
  }).map(y => y.name);

  const prompt = `I have a South Indian Vedic (Jyotisha) natal chart with the following planetary positions. Please analyze this chart using classical Vedic astrology principles (Parashari system).

‚ïê‚ïê‚ïê CHART DETAILS ‚ïê‚ïê‚ïê
${lagnaText}

${planetLines.join('\n')}
${detectedYogas.length > 0 ? `\nDetected Yogas: ${detectedYogas.join(', ')}` : ''}

‚ïê‚ïê‚ïê READING REQUEST ‚ïê‚ïê‚ïê
Please provide a comprehensive Vedic astrology reading covering all major life areas: personality, health, career, finances, relationships, family, spirituality, and life purpose. Discuss the strength and effects of each planet, any special yogas or combinations, and major themes of this chart.

Please use traditional Vedic astrology methods (not Western/Tropical). Consider planetary dignities, house lordships, conjunctions, and special aspects in your analysis.`;

  getEl('#promptOutput').textContent = prompt;
}

/* ‚îÄ‚îÄ‚îÄ Language UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function applyLang() {
  const t = T();
  getEl('#appTitle').textContent    = t.title;
  getEl('#appSubtitle').textContent = t.subtitle;
  getEl('#bankTitle').textContent   = t.bankTitle;
  getEl('#bankTip').textContent     = t.bankTip;
  getEl('#degHint').textContent     = t.degHint;
  getEl('#centerLine1').textContent = t.center1;
  getEl('#centerLine2').textContent = t.center2;
  getEl('#retroLabel').textContent  = t.retroLabel;
  getEl('#retroClose').textContent  = t.close;
  getEl('#spClose').textContent     = t.close;
  getEl('#btnSigns').textContent    = signsHidden ? t.showSigns : t.hideSigns;
  getEl('#btnNums').textContent     = numsHidden  ? t.showNums  : t.hideNums;
  getEl('#btnClear').textContent    = t.clearChart;
  updateSignLabels();
  updateHouseNums();
  refreshAllPlanets();
}

/* ‚îÄ‚îÄ‚îÄ Tooltip ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const tooltip = getEl('#tooltip');

function showTooltip(pid, x, y) {
  const t = T();
  const d = planetData[pid];
  if (!d) return;
  const nak = getNakshatra(d.sign, d.degree);
  const pname = t.pnames[pid] || pid;
  const signName = t.snames[d.sign] || d.sign;
  const strength = getStrength(pid, d.sign);

  let html = `<strong>${pname}</strong>`;
  html += `<div class="trow">${d.degree.toFixed(2)}¬∞ ${signName}</div>`;
  html += `<div class="trow"><span>${t.nakshatra}:</span> ${nak.name} (Lord: ${nak.lord})</div>`;
  html += `<div class="trow"><span>Keywords:</span> ${nak.kw}</div>`;
  html += `<div class="trow"><span>${t.pada}:</span> ${nak.pada}</div>`;
  if (strength) {
    const sc = strength === 'exalted' ? 'var(--green)' : strength === 'debilitated' ? 'var(--red)' : 'var(--gold)';
    const sl = {exalted: t.exalted, debilitated: t.debilitated, own: t.ownSign};
    html += `<div class="trow" style="color:${sc}">‚¨• ${sl[strength]}</div>`;
  }
  if (d.retro) html += `<div class="trow" style="color:var(--red)">(${t.retroLabel})</div>`;

  if (lagnaSign && PLANET_RULES[pid]) {
    html += `<hr><div style="color:var(--gold);font-family:'Cinzel',serif;font-size:0.7rem;margin-bottom:2px">${t.houseLord}</div>`;
    PLANET_RULES[pid].forEach(rs => {
      // FIX #4: explicit lagnaSign
      const hn = houseNum(rs, lagnaSign);
      if (!hn) return;
      const hnName = t.hn[hn] || `H${hn}`;
      const kws = HOUSE_KW[hn] || '';
      html += `<div class="trow">${t.lordOf} ${hnName}: <span>${kws.split(',').slice(0,2).join(',')}</span></div>`;
    });
  }

  tooltip.innerHTML = html;
  tooltip.classList.add('visible');
  // FIX #9: use setTimeout to allow browser to render before measuring dimensions
  setTimeout(() => positionFloating(tooltip, x, y), 0);
}

function hideTooltip() { tooltip.classList.remove('visible'); }

function positionFloating(el, x, y) {
  const w  = el.offsetWidth  || 200;
  const h  = el.offsetHeight || 100;
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  let lx = x + 14, ly = y - h - 10;
  if (lx + w > vw - 8) lx = x - w - 14;
  if (lx < 8) lx = 8;
  if (ly < 8) ly = y + 24;
  if (ly + h > vh - 8) ly = vh - h - 8;
  el.style.left = lx + 'px';
  el.style.top  = ly + 'px';
}

/* ‚îÄ‚îÄ‚îÄ Sign Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const signPanel = getEl('#signPanel');

function showSignPanel(sign, x, y) {
  hideAllPanels();
  const t = T();
  const sd = SIGN_DATA[sign];
  // FIX #4: explicit lagnaSign
  const hn = houseNum(sign, lagnaSign);
  getEl('#spSignName').textContent = `${sd?.symbol || ''} ${t.snames[sign] || sign}`;
  let body = '';
  if (hn) {
    body += `<div><strong>${t.house}:</strong> ${t.hn[hn]}</div>`;
    body += `<div><strong>${t.houseKw}:</strong> ${HOUSE_KW[hn]}</div>`;
    body += `<hr>`;
  } else {
    body += `<div style="color:var(--text-muted);font-style:italic">${t.noLagna}</div><hr>`;
  }
  if (sd) {
    body += `<div><strong>${t.signKw}:</strong> ${sd.kw}</div>`;
    body += `<div><strong>${t.ruler}:</strong> ${sd.ruler} &nbsp;|&nbsp; <strong>${t.element}:</strong> ${sd.el} &nbsp;|&nbsp; <strong>${t.modality}:</strong> ${sd.mod}</div>`;
  }
  getEl('#spBody').innerHTML = body;
  signPanel.classList.add('visible');
  getEl('#overlay').classList.add('visible');
  // FIX #9: defer positioning until DOM is painted
  setTimeout(() => positionFloating(signPanel, x, y), 0);
}

function hideSignPanel() { signPanel.classList.remove('visible'); }

/* ‚îÄ‚îÄ‚îÄ Retrograde Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const retroPanel = getEl('#retroPanel');
const retroCheck = getEl('#retroCheck');
const retroTitle = getEl('#retroTitle');
const degInput   = getEl('#degInput');

function showRetroPanel(pid, x, y) {
  hideAllPanels();
  activePlanetForRetro = pid;
  const t = T();
  retroTitle.textContent = t.pnames[pid] || pid;
  retroCheck.checked = !!(planetData[pid]?.retro);
  degInput.value = planetData[pid]?.degree?.toFixed(2) ?? '0';
  retroPanel.classList.add('visible');
  getEl('#overlay').classList.add('visible');
  // FIX #9: defer positioning until DOM is painted
  setTimeout(() => positionFloating(retroPanel, x, y), 0);
}

function hideRetroPanel() {
  retroPanel.classList.remove('visible');
  activePlanetForRetro = null;
}

function hideAllPanels() {
  hideTooltip();
  hideSignPanel();
  hideRetroPanel();
  getEl('#overlay').classList.remove('visible');
}

retroCheck.addEventListener('change', () => {
  if (!activePlanetForRetro || !planetData[activePlanetForRetro]) return;
  planetData[activePlanetForRetro].retro = retroCheck.checked;
  const el = document.querySelector(`.planets-area .planet[data-pid="${activePlanetForRetro}"]`);
  if (el) refreshPlanetContent(el);
  saveState();
  scheduleYogaUpdate();
});

// FIX #11: clamp the degree value on blur rather than on every keystroke mid-edit
degInput.addEventListener('input', () => {
  if (!activePlanetForRetro || !planetData[activePlanetForRetro]) return;
  let v = parseFloat(degInput.value);
  if (isNaN(v)) return;
  // Allow typing freely; only update the model (not the input value itself)
  v = Math.max(0, Math.min(29.99, v));
  planetData[activePlanetForRetro].degree = v;
  const el = document.querySelector(`.planets-area .planet[data-pid="${activePlanetForRetro}"]`);
  if (el) refreshPlanetContent(el);
  saveState();
  scheduleYogaUpdate();
});

// FIX #11: clamp and sync the displayed value on blur
degInput.addEventListener('blur', () => {
  if (!activePlanetForRetro || !planetData[activePlanetForRetro]) return;
  let v = parseFloat(degInput.value);
  if (isNaN(v)) v = 0;
  v = Math.max(0, Math.min(29.99, parseFloat(v.toFixed(2))));
  planetData[activePlanetForRetro].degree = v;
  degInput.value = v.toFixed(2);
  const el = document.querySelector(`.planets-area .planet[data-pid="${activePlanetForRetro}"]`);
  if (el) refreshPlanetContent(el);
  saveState();
  scheduleYogaUpdate();
});

getEl('#retroClose').addEventListener('click', hideAllPanels);
getEl('#retroClose').addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') hideAllPanels(); });
getEl('#spClose').addEventListener('click', hideAllPanels);
getEl('#spClose').addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') hideAllPanels(); });
getEl('#overlay').addEventListener('click', hideAllPanels);

/* ‚îÄ‚îÄ‚îÄ Move planet into chart sign ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function movePlanetToSign(pid, targetSign) {
  const existing = document.querySelector(`.planet[data-pid="${pid}"]`);
  if (existing) existing.remove();
  if (pid === 'Lagna') lagnaSign = targetSign;
  const area = document.querySelector(`.planets-area[data-sign="${targetSign}"]`);
  if (!area) return;
  if (!planetData[pid]) {
    planetData[pid] = { sign: targetSign, degree: parseFloat((Math.random() * 30).toFixed(2)), retro: false };
  } else {
    planetData[pid].sign = targetSign;
  }
  const el = buildPlanet(pid);
  area.appendChild(el);
  updateHouseNums();
  updateOverflowIndicators();
  saveState();
  scheduleYogaUpdate();
  scheduleAspectUpdate();
}

/* ‚îÄ‚îÄ‚îÄ Return planet to bank ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function returnPlanetToBank(pid) {
  const existing = document.querySelector(`.planets-area .planet[data-pid="${pid}"]`);
  if (!existing) return;
  existing.remove();
  delete planetData[pid];
  if (pid === 'Lagna') { lagnaSign = null; updateHouseNums(); }
  updateOverflowIndicators();
  // FIX #17: always use rebuildBank for consistent ordering
  rebuildBank();
  saveState();
  scheduleYogaUpdate();
  scheduleAspectUpdate();
}

/* ‚ïê‚ïê‚ïê DRAG & DROP (Pointer Events) ‚ïê‚ïê‚ïê */
const ghost = getEl('#drag-ghost');

document.addEventListener('pointerdown', onPointerDown, {passive: false});
document.addEventListener('pointermove', onPointerMove, {passive: false});
document.addEventListener('pointerup',   onPointerUp,   {passive: false});
document.addEventListener('pointercancel', onPointerCancel);

function onPointerDown(e) {
  if (dragState) return;
  const planetEl = e.target.closest('.planet');
  if (!planetEl) return;
  e.preventDefault();
  const pid = planetEl.dataset.pid;
  const inChart = !!planetEl.closest('.planets-area');
  const inBank  = !!planetEl.closest('#planetBank');
  if (!inChart && !inBank) return;
  dragState = {
    pid, pointerId: e.pointerId, sourceEl: planetEl,
    startX: e.clientX, startY: e.clientY,
    moved: false, isDegreeMode: false, directionLocked: false,
    initDeg: 0, inChart, ghostShown: false
  };
}

function onPointerMove(e) {
  if (!dragState || e.pointerId !== dragState.pointerId) return;
  e.preventDefault();
  const dx = e.clientX - dragState.startX;
  const dy = e.clientY - dragState.startY;
  const dist = Math.hypot(dx, dy);
  if (dist < 5) return;
  dragState.moved = true;

  if (dragState.inChart && !dragState.directionLocked) {
    dragState.isDegreeMode    = Math.abs(dy) > Math.abs(dx);
    dragState.directionLocked = true;
    dragState.initDeg = planetData[dragState.pid]?.degree ?? 0;
  }

  if (dragState.isDegreeMode) {
    const delta = (dragState.startY - e.clientY) / 22;
    let newDeg = dragState.initDeg + delta;
    newDeg = Math.max(0, Math.min(29.99, parseFloat(newDeg.toFixed(2))));
    if (planetData[dragState.pid]) {
      planetData[dragState.pid].degree = newDeg;
      refreshPlanetContent(dragState.sourceEl);
      showTooltip(dragState.pid, e.clientX, e.clientY);
    }
    return;
  }

  if (!dragState.ghostShown) {
    dragState.ghostShown = true;
    dragState.sourceEl.classList.add('dragging');
    dragState.sourceEl.style.pointerEvents = 'none';
    hideAllPanels();
    const inner = dragState.sourceEl.cloneNode(true);
    inner.style.transform = 'none';
    inner.style.pointerEvents = 'none';
    ghost.innerHTML = '';
    ghost.appendChild(inner);
    ghost.style.display = 'block';
    requestAnimationFrame(() => {
      const w = ghost.offsetWidth  || 50;
      const h = ghost.offsetHeight || 26;
      ghost.style.left = (e.clientX - w / 2) + 'px';
      ghost.style.top  = (e.clientY - h / 2) + 'px';
    });
    return;
  }

  const w = ghost.offsetWidth  || 50;
  const h = ghost.offsetHeight || 26;
  ghost.style.left = (e.clientX - w / 2) + 'px';
  ghost.style.top  = (e.clientY - h / 2) + 'px';

  getAll('.cell.drop-active, .planet-bank.drop-active').forEach(el => el.classList.remove('drop-active'));
  const under = getDropTarget(e.clientX, e.clientY);
  if (under) under.classList.add('drop-active');
}

// FIX #1 & #2: capture all state we need before any mutation, avoid null-after-nulled reads
function onPointerUp(e) {
  if (!dragState || e.pointerId !== dragState.pointerId) return;
  e.preventDefault();

  // Snapshot everything we need BEFORE cleanupDrag mutates state
  const { pid, moved, isDegreeMode, inChart } = dragState;

  cleanupDrag();

  if (!moved) {
    // Tap: open retro panel if placed in chart
    if (inChart && planetData[pid]) {
      showRetroPanel(pid, e.clientX, e.clientY);
    }
    dragState = null;
    return;
  }

  if (isDegreeMode) {
    // Degree scrub ended ‚Äî persist the final value
    saveState();
    dragState = null;
    return;
  }

  lastDragEndTime = Date.now();
  const under = getDropTarget(e.clientX, e.clientY);
  dragState = null; // null AFTER we've read all needed fields above

  if (under) {
    if (under.id === 'planetBank') returnPlanetToBank(pid);
    else if (under.dataset.sign) movePlanetToSign(pid, under.dataset.sign);
  }
}

function onPointerCancel(e) {
  if (!dragState || e.pointerId !== dragState.pointerId) return;
  cleanupDrag();
  dragState = null;
  hideTooltip();
}

function cleanupDrag() {
  ghost.style.display = 'none';
  ghost.innerHTML = '';
  getAll('.cell.drop-active, .planet-bank.drop-active').forEach(el => el.classList.remove('drop-active'));
  if (dragState?.sourceEl) {
    dragState.sourceEl.classList.remove('dragging');
    dragState.sourceEl.style.pointerEvents = '';
  }
  hideTooltip();
}

function getDropTarget(x, y) {
  const els = document.elementsFromPoint(x, y);
  for (const el of els) {
    const cell = el.closest('.cell[data-sign]');
    if (cell) return cell;
    if (el.id === 'planetBank' || el.closest('#planetBank')) return getEl('#planetBank');
  }
  return null;
}

/* ‚îÄ‚îÄ‚îÄ Double-tap to return ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let lastTap = {pid: null, time: 0};

document.addEventListener('click', (e) => {
  // FIX #3: use a tighter guard ‚Äî only block if drag just ended within 400ms
  if (Date.now() - lastDragEndTime < 400) return;
  const planetEl = e.target.closest('.planet');
  if (!planetEl || !planetEl.closest('.planets-area')) return;
  const pid = planetEl.dataset.pid;
  const now = Date.now();
  if (lastTap.pid === pid && now - lastTap.time < 400) {
    returnPlanetToBank(pid);
    hideAllPanels();
    lastTap = {pid: null, time: 0};
  } else {
    lastTap = {pid, time: now};
  }
});

/* ‚îÄ‚îÄ‚îÄ Keyboard: Enter/Space on sign-abbr ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
// FIX #12: keyboard interaction for sign labels
getAll('.sign-abbr').forEach(el => {
  el.addEventListener('keydown', (ev) => {
    if ((ev.key === 'Enter' || ev.key === ' ') && !signsHidden) {
      ev.preventDefault();
      const rect = el.getBoundingClientRect();
      showSignPanel(el.dataset.sign, rect.right, rect.bottom);
    }
  });
});

/* ‚îÄ‚îÄ‚îÄ Sign label click ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
// FIX #10: removed mouseenter handler; click-only on desktop to prevent double-open
getAll('.sign-abbr').forEach(el => {
  el.addEventListener('click', (ev) => {
    // Don't open if the panel is already showing for this sign
    if (signPanel.classList.contains('visible')) {
      hideAllPanels();
      return;
    }
    ev.stopPropagation();
    if (!signsHidden) showSignPanel(el.dataset.sign, ev.clientX, ev.clientY);
  });
});

/* ‚îÄ‚îÄ‚îÄ Desktop hover tooltip ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.addEventListener('mousemove', (e) => {
  if (dragState) return;
  const planetEl = e.target.closest('.planet');
  if (planetEl && planetEl.closest('.planets-area') && planetData[planetEl.dataset.pid]) {
    showTooltip(planetEl.dataset.pid, e.clientX, e.clientY);
  } else if (!e.target.closest('#tooltip')) {
    hideTooltip();
  }
});

/* ‚îÄ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => {
      b.classList.remove('active');
      b.setAttribute('aria-selected', 'false');
    });
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    btn.setAttribute('aria-selected', 'true');
    const tabId = btn.dataset.tab;
    document.getElementById(`tab-${tabId}`).classList.add('active');
    if (tabId === 'aspects') updateAspects();
    if (tabId === 'prompt') generatePrompt();
  });
});

getEl('#btnGenPrompt').addEventListener('click', generatePrompt);

// FIX #16: replaced deprecated execCommand with Clipboard API only; no fallback to execCommand
getEl('#btnCopyPrompt').addEventListener('click', async () => {
  const text = getEl('#promptOutput').textContent;
  if (!text) return;
  try {
    await navigator.clipboard.writeText(text);
    showCopyToast();
  } catch (err) {
    // Fallback: select text for manual copy if clipboard API unavailable
    const output = getEl('#promptOutput');
    const range = document.createRange();
    range.selectNodeContents(output);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    showCopyToast('Text selected ‚Äî press Ctrl+C / Cmd+C to copy');
  }
});

function showCopyToast(msg) {
  const toast = getEl('#copyToast');
  toast.textContent = msg || '‚úì Copied to clipboard!';
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2200);
}

/* ‚îÄ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
getEl('#btnSigns').addEventListener('click', () => {
  signsHidden = !signsHidden;
  getEl('#btnSigns').textContent = signsHidden ? T().showSigns : T().hideSigns;
  updateSignLabels();
});

getEl('#btnNums').addEventListener('click', () => {
  numsHidden = !numsHidden;
  getEl('#btnNums').textContent = numsHidden ? T().showNums : T().hideNums;
  updateHouseNums();
});

getEl('#btnClear').addEventListener('click', () => {
  getAll('.planets-area .planet').forEach(el => el.remove());
  planetData = {};
  lagnaSign = null;
  signsHidden = false;
  numsHidden = false;
  dragState = null;
  ghost.style.display = 'none';
  rebuildBank();
  applyLang();
  scheduleYogaUpdate();
  scheduleAspectUpdate();
  updateOverflowIndicators();
  getEl('#promptOutput').textContent = '';
  hideAllPanels();
  clearSavedState();
});

getEl('#lang').addEventListener('change', (e) => {
  lang = e.target.value;
  applyLang();
  hideAllPanels();
});

/* ‚îÄ‚îÄ‚îÄ Close panels on outside tap ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.addEventListener('pointerdown', (e) => {
  if (!retroPanel.classList.contains('visible') &&
      !signPanel.classList.contains('visible')) return;
  if (e.target.closest('#retroPanel') ||
      e.target.closest('#signPanel')  ||
      e.target.closest('.sign-abbr')) return;
  hideAllPanels();
}, {capture: true});

/* ‚ïê‚ïê‚ïê FIX #15: localStorage persistence ‚ïê‚ïê‚ïê */
const STORAGE_KEY = 'vedic-chart-v1';

function saveState() {
  try {
    const state = { planetData, lagnaSign, lang };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    // Show save indicator briefly
    const notice = getEl('#persistNotice');
    notice.classList.add('show');
    clearTimeout(notice._timer);
    notice._timer = setTimeout(() => notice.classList.remove('show'), 1800);
  } catch(e) {
    // localStorage might be unavailable (private mode, storage full)
  }
}

function clearSavedState() {
  try { localStorage.removeItem(STORAGE_KEY); } catch(e) {}
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    const state = JSON.parse(raw);
    if (!state || typeof state !== 'object') return false;

    // Restore language
    if (state.lang && TRANS[state.lang]) {
      lang = state.lang;
      getEl('#lang').value = lang;
    }

    // Restore planet data
    if (state.planetData && typeof state.planetData === 'object') {
      planetData = {};
      for (const [pid, d] of Object.entries(state.planetData)) {
        if (!ALL_PIDS.includes(pid)) continue;
        if (!SIGNS.includes(d?.sign)) continue;
        planetData[pid] = {
          sign:   d.sign,
          degree: Math.max(0, Math.min(29.99, parseFloat(d.degree) || 0)),
          retro:  !!d.retro
        };
      }
    }

    // Restore lagnaSign
    if (state.lagnaSign && SIGNS.includes(state.lagnaSign)) {
      lagnaSign = state.lagnaSign;
    } else if (planetData['Lagna']) {
      lagnaSign = planetData['Lagna'].sign;
    }

    return true;
  } catch(e) {
    return false;
  }
}

function restorePlanetsFromState() {
  // Place each planet into its stored sign
  for (const pid of ALL_PIDS) {
    if (!planetData[pid]) continue;
    const d = planetData[pid];
    const area = document.querySelector(`.planets-area[data-sign="${d.sign}"]`);
    if (!area) continue;
    const el = buildPlanet(pid);
    area.appendChild(el);
  }
  // Remove restored planets from the bank
  rebuildBank();
}

/* ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const hadSaved = loadState();
applyLang();

if (hadSaved) {
  restorePlanetsFromState();
}

updateHouseNums();
updateOverflowIndicators();
scheduleYogaUpdate();
scheduleAspectUpdate();
</script>
</body>
</html>
