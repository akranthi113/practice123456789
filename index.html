<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Vedic Astrology South Indian Chart</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f0e8;
  --surface: #ffffff;
  --card: #fdfaf5;
  --card2: #f0ebe0;
  --border: #d8ccb4;
  --border-bright: #b8a888;
  --gold: #8b6914;
  --gold-light: #a8821e;
  --gold-dim: #c4a44a;
  --accent: #4a6fa5;
  --accent-light: #6389bf;
  --text: #2c2416;
  --text-dim: #6b5b3e;
  --text-muted: #a8956e;
  --red: #c0392b;
  --green: #27ae60;
  --sun: #e8920e;
  --moon: #6b7b80;
  --mars: #b83228;
  --mercury: #229954;
  --jupiter: #d4710e;
  --venus: #c9176f;
  --saturn: #4a5db0;
  --rahu: #526370;
  --ketu: #6d4c41;
  --shadow: 0 2px 16px rgba(139,105,20,0.12);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg);
  background-image: radial-gradient(ellipse at 30% 10%, rgba(139,105,20,0.06) 0%, transparent 50%);
  color: var(--text);
  font-family: 'Crimson Pro', Georgia, serif;
  min-height: 100vh;
  padding: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  -webkit-tap-highlight-color: transparent;
  overflow-x: hidden;
}
.app-header { text-align:center; margin-bottom:14px; width:100%; max-width:600px; }
.app-title {
  font-family:'Cinzel',serif; font-size:clamp(0.95rem,3.5vw,1.45rem);
  font-weight:700; color:var(--gold); letter-spacing:0.08em; line-height:1.3;
}
.app-subtitle { font-size:0.82rem; color:var(--text-muted); margin-top:3px; font-style:italic; }
.app-wrap { width:100%; max-width:600px; display:flex; flex-direction:column; gap:12px; }
.lang-row { display:flex; justify-content:flex-end; align-items:center; gap:8px; }
.lang-label { font-size:0.78rem; color:var(--text-muted); }
select#lang {
  background:var(--surface); color:var(--text); border:1px solid var(--border-bright);
  border-radius:6px; padding:5px 10px; font-family:inherit; font-size:0.82rem;
  cursor:pointer; outline:none; min-height:36px;
}

/* Chart */
.chart-wrap {
  position:relative; background:var(--surface); border:2px solid var(--border-bright);
  border-radius:10px; overflow:hidden; box-shadow:var(--shadow); max-width:100%;
}
.chart-grid {
  display:grid; grid-template-columns:repeat(4,1fr);
  grid-template-rows:repeat(4,minmax(72px,1fr));
  gap:1px; background:var(--border); width:100%;
  grid-template-areas:
    "pisces  aries   taurus  gemini"
    "aquarius center center  cancer"
    "capricorn center center leo"
    "sagittarius scorpio libra virgo";
}
.cell {
  background:var(--card); position:relative; display:flex; flex-direction:column;
  align-items:center; justify-content:flex-start; padding:3px; min-height:72px;
  overflow:visible; transition:background 0.15s;
}
.cell.drop-active { background:rgba(74,111,165,0.12); outline:2px dashed var(--accent-light); outline-offset:-2px; }
.cell[data-sign="Pisces"]      { grid-area:pisces; }
.cell[data-sign="Aries"]       { grid-area:aries; }
.cell[data-sign="Taurus"]      { grid-area:taurus; }
.cell[data-sign="Gemini"]      { grid-area:gemini; }
.cell[data-sign="Aquarius"]    { grid-area:aquarius; }
.cell[data-sign="Cancer"]      { grid-area:cancer; }
.cell[data-sign="Capricorn"]   { grid-area:capricorn; }
.cell[data-sign="Leo"]         { grid-area:leo; }
.cell[data-sign="Sagittarius"] { grid-area:sagittarius; }
.cell[data-sign="Scorpio"]     { grid-area:scorpio; }
.cell[data-sign="Libra"]       { grid-area:libra; }
.cell[data-sign="Virgo"]       { grid-area:virgo; }
.cell-center {
  grid-area:center; background:var(--card2); display:flex; flex-direction:column;
  align-items:center; justify-content:center; gap:3px;
}
.center-line {
  font-family:'Cinzel',serif; font-size:0.58rem; color:var(--text-muted);
  letter-spacing:0.14em; text-transform:uppercase;
}
.sign-abbr {
  position:absolute; top:2px; left:3px; font-family:'Cinzel',serif; font-size:0.58rem;
  font-weight:600; color:var(--text-muted); background:rgba(139,105,20,0.07);
  padding:1px 3px; border-radius:3px; cursor:pointer; z-index:2; user-select:none;
  transition:background 0.15s,color 0.15s; min-width:20px; text-align:center;
  -webkit-user-select:none;
}
.sign-abbr:hover,.sign-abbr:active { color:var(--gold); background:rgba(139,105,20,0.15); }
.sign-abbr.hidden-label { visibility:hidden; }
.house-num {
  position:absolute; bottom:2px; right:3px; font-family:'Cinzel',serif; font-size:0.58rem;
  color:var(--accent); font-weight:700; opacity:0.72; z-index:2; pointer-events:none;
}
.house-num.hidden-label { visibility:hidden; }
.planets-area {
  display:flex; flex-wrap:wrap; gap:2px; justify-content:center; align-items:flex-start;
  align-content:flex-start; width:100%; min-height:26px; margin-top:18px; padding:1px;
}

/* Planet chips */
.planet {
  display:inline-flex; align-items:center; gap:2px; padding:3px 6px; border-radius:5px;
  font-family:'Cinzel',serif; font-size:0.65rem; font-weight:600; cursor:pointer;
  user-select:none; -webkit-user-select:none; white-space:nowrap;
  transition:transform 0.1s,box-shadow 0.1s; box-shadow:0 1px 3px rgba(0,0,0,0.2);
  position:relative; touch-action:none; -webkit-touch-callout:none;
  min-width:30px; justify-content:center; z-index:3; color:#fff;
}
@media(hover:hover){ .planet:hover { transform:translateY(-1px); box-shadow:0 2px 8px rgba(0,0,0,0.25); } }
.planet.dragging { opacity:0.25; }
.planet.tap-flash { outline:2px solid rgba(139,105,20,0.5); outline-offset:1px; }
.planet.Lagna { background:transparent!important; border:2px solid var(--gold); color:var(--gold)!important; font-size:0.6rem; box-shadow:none; }
.planet.Sun     { background:var(--sun); }
.planet.Moon    { background:var(--moon); }
.planet.Mars    { background:var(--mars); }
.planet.Mercury { background:var(--mercury); }
.planet.Jupiter { background:var(--jupiter); }
.planet.Venus   { background:var(--venus); }
.planet.Saturn  { background:var(--saturn); }
.planet.Rahu    { background:var(--rahu); }
.planet.Ketu    { background:var(--ketu); }
.retro-mark { font-size:0.55rem; color:#ffd0d0; font-weight:900; line-height:1; margin-left:1px; vertical-align:super; }
.planet.Lagna .retro-mark { color:var(--red); }
.deg-label { font-size:0.52rem; opacity:0.88; font-family:'Crimson Pro',serif; font-weight:400; }
#drag-ghost { position:fixed; pointer-events:none; z-index:9999; opacity:0.9; transform:scale(1.15); display:none; }

/* Panel */
.panel { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:12px; box-shadow:var(--shadow); }
.panel-title { font-family:'Cinzel',serif; font-size:0.7rem; font-weight:600; color:var(--text-muted); letter-spacing:0.12em; text-transform:uppercase; margin-bottom:10px; }
.planet-bank {
  display:flex; flex-wrap:wrap; gap:6px; justify-content:center; min-height:44px;
  padding:8px; background:var(--card2); border:1px dashed var(--border-bright);
  border-radius:8px; margin-bottom:10px; transition:background 0.15s,border-color 0.15s;
}
.planet-bank.drop-active { background:rgba(74,111,165,0.09); border-color:var(--accent-light); }
.planet-bank .planet { font-size:0.74rem; padding:6px 11px; min-width:40px; min-height:36px; }
.tip-box {
  font-size:0.76rem; color:var(--text-dim); background:rgba(139,105,20,0.05);
  border-left:3px solid var(--gold-dim); padding:7px 10px; border-radius:0 6px 6px 0;
  line-height:1.5; margin-top:8px; font-style:italic;
}
.btn-row { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:10px; }
.btn {
  padding:9px 16px; font-family:'Cinzel',serif; font-size:0.68rem; font-weight:600;
  letter-spacing:0.05em; border:1px solid var(--border-bright); background:var(--surface);
  color:var(--text-dim); border-radius:6px; cursor:pointer; transition:all 0.15s;
  text-transform:uppercase; min-height:38px;
}
.btn:hover,.btn:active { background:var(--card2); color:var(--text); border-color:var(--gold-dim); }
.btn.danger { border-color:rgba(192,57,43,0.35); color:var(--red); }
.btn.danger:hover,.btn.danger:active { background:rgba(192,57,43,0.07); }
.deg-hint { font-size:0.68rem; color:var(--text-muted); text-align:center; padding:4px; font-style:italic; margin-top:4px; }

/* Prompt */
.prompt-output {
  background:var(--card2); border:1px solid var(--border); border-radius:8px; padding:12px;
  font-size:0.78rem; line-height:1.65; color:var(--text); white-space:pre-wrap;
  word-break:break-word; max-height:280px; overflow-y:auto; font-family:'Crimson Pro',serif;
  -webkit-overflow-scrolling:touch;
}
.prompt-output:empty::before { content:'Place Lagna and planets, then tap Generate‚Ä¶'; color:var(--text-muted); font-style:italic; }

/* Toast */
.copy-toast {
  position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(70px);
  background:rgba(39,174,96,0.96); color:#fff; font-family:'Cinzel',serif; font-size:0.74rem;
  letter-spacing:0.07em; padding:10px 22px; border-radius:24px;
  box-shadow:0 4px 18px rgba(0,0,0,0.2); z-index:9999;
  transition:transform 0.32s cubic-bezier(0.34,1.56,0.64,1),opacity 0.3s; opacity:0; pointer-events:none;
}
.copy-toast.show { transform:translateX(-50%) translateY(0); opacity:1; }

/* Tabs */
.tab-row { display:flex; background:var(--card2); border:1px solid var(--border); border-radius:8px; overflow:hidden; }
.tab-btn {
  flex:1; padding:10px 4px; font-family:'Cinzel',serif; font-size:0.65rem; font-weight:600;
  letter-spacing:0.04em; border:none; background:transparent; color:var(--text-muted);
  cursor:pointer; transition:all 0.15s; text-transform:uppercase;
  border-right:1px solid var(--border); min-height:40px;
}
.tab-btn:last-child { border-right:none; }
.tab-btn.active { background:var(--surface); color:var(--gold); }
.tab-btn:hover:not(.active),.tab-btn:active:not(.active) { background:rgba(139,105,20,0.05); color:var(--text-dim); }
.tab-content { display:none; }
.tab-content.active { display:block; }

/* Tooltip */
.tooltip {
  position:fixed; background:rgba(255,252,245,0.99); border:1px solid var(--border-bright);
  border-radius:8px; padding:10px 13px; font-size:0.78rem; line-height:1.6; color:var(--text);
  z-index:5000; pointer-events:none; max-width:min(270px,90vw);
  box-shadow:0 6px 24px rgba(139,105,20,0.18); display:none;
}
.tooltip.visible { display:block; }
.tooltip strong { color:var(--gold); font-family:'Cinzel',serif; font-size:0.74rem; }
.tooltip hr { border:none; border-top:1px solid var(--border); margin:5px 0; }
.tooltip .trow { display:block; margin-bottom:1px; }
.tooltip .trow span { color:var(--text-muted); }

/* Retro panel */
.retro-panel {
  position:fixed; background:rgba(255,252,245,0.99); border:1px solid var(--gold-dim);
  border-radius:10px; padding:14px; z-index:5000;
  box-shadow:0 6px 28px rgba(139,105,20,0.22); display:none; flex-direction:column;
  gap:12px; min-width:200px; max-width:min(280px,92vw);
}
.retro-panel.visible { display:flex; }
.retro-panel-title { font-family:'Cinzel',serif; font-size:0.8rem; color:var(--gold); font-weight:700; border-bottom:1px solid var(--border); padding-bottom:6px; }
.retro-panel label { display:flex; align-items:center; gap:12px; cursor:pointer; font-size:0.9rem; color:var(--text); min-height:36px; }
.retro-panel input[type=checkbox] { width:20px; height:20px; accent-color:var(--gold); cursor:pointer; flex-shrink:0; }
.deg-input-row { display:flex; align-items:center; gap:8px; font-size:0.85rem; color:var(--text-dim); }
.deg-input-row input[type=number] {
  width:72px; background:var(--card2); border:1px solid var(--border-bright); border-radius:5px;
  color:var(--text); padding:6px 8px; font-family:'Crimson Pro',serif; font-size:1rem;
  outline:none; min-height:36px;
}
.deg-input-row input[type=number]:focus { border-color:var(--gold-dim); }
.retro-panel-close {
  align-self:flex-end; font-size:0.7rem; color:var(--text-muted); cursor:pointer;
  padding:5px 12px; border:1px solid var(--border); border-radius:4px; font-family:'Cinzel',serif;
  min-height:32px; display:flex; align-items:center;
}
.retro-panel-close:hover,.retro-panel-close:active { color:var(--text); border-color:var(--border-bright); }

/* Sign panel */
.sign-panel {
  position:fixed; background:rgba(255,252,245,0.99); border:1px solid var(--border-bright);
  border-radius:10px; padding:12px 14px; z-index:5000;
  box-shadow:0 6px 24px rgba(139,105,20,0.15); display:none; flex-direction:column;
  gap:4px; max-width:min(260px,92vw); font-size:0.8rem; line-height:1.55;
}
.sign-panel.visible { display:flex; }
.sign-panel strong { color:var(--gold); font-family:'Cinzel',serif; font-size:0.76rem; }
.sign-panel hr { border:none; border-top:1px solid var(--border); margin:4px 0; }
.sign-panel .sp-close {
  align-self:flex-end; font-size:0.7rem; color:var(--text-muted); cursor:pointer;
  padding:5px 12px; border:1px solid var(--border); border-radius:4px; font-family:'Cinzel',serif;
  min-height:32px; display:flex; align-items:center;
}
.sign-panel .sp-close:hover,.sign-panel .sp-close:active { color:var(--text); }

.empty-state { font-size:0.8rem; color:var(--text-muted); text-align:center; padding:12px; font-style:italic; }
.aspect-entry {
  margin-bottom:6px; padding:7px 10px; background:var(--card2); border-radius:6px;
  border:1px solid var(--border); display:flex; align-items:center; gap:8px;
  flex-wrap:wrap; font-size:0.76rem;
}
.overlay { position:fixed; inset:0; z-index:4999; display:none; }
.overlay.visible { display:block; }

@media(max-width:400px){
  body { padding:10px 8px; }
  .chart-grid { grid-template-rows:repeat(4,minmax(62px,1fr)); }
  .cell { min-height:62px; padding:2px; }
  .planet { font-size:0.58rem; padding:2px 4px; min-width:26px; }
  .planet-bank .planet { font-size:0.68rem; padding:5px 8px; min-width:36px; }
  .sign-abbr { font-size:0.52rem; }
  .house-num { font-size:0.52rem; }
  .tab-btn { font-size:0.58rem; padding:9px 2px; }
  .btn { font-size:0.62rem; padding:8px 10px; }
}
</style>
</head>
<body>

<div id="drag-ghost"></div>
<div class="overlay" id="overlay"></div>
<div class="copy-toast" id="copyToast">‚úì Copied to clipboard!</div>

<div class="app-header">
  <div class="app-title" id="appTitle">South Indian Vedic Astrology Chart</div>
  <div class="app-subtitle" id="appSubtitle">Interactive ‚Ä¢ Drag planets into signs</div>
</div>

<div class="app-wrap">
  <div class="lang-row">
    <span class="lang-label">Language:</span>
    <select id="lang"><option value="en">English</option><option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option></select>
  </div>

  <div class="chart-wrap">
    <div class="chart-grid">
      <div class="cell" data-sign="Pisces">      <span class="sign-abbr" data-sign="Pisces">Pi</span>      <span class="house-num"></span><div class="planets-area" data-sign="Pisces"></div></div>
      <div class="cell" data-sign="Aries">       <span class="sign-abbr" data-sign="Aries">Ar</span>       <span class="house-num"></span><div class="planets-area" data-sign="Aries"></div></div>
      <div class="cell" data-sign="Taurus">      <span class="sign-abbr" data-sign="Taurus">Ta</span>      <span class="house-num"></span><div class="planets-area" data-sign="Taurus"></div></div>
      <div class="cell" data-sign="Gemini">      <span class="sign-abbr" data-sign="Gemini">Ge</span>      <span class="house-num"></span><div class="planets-area" data-sign="Gemini"></div></div>
      <div class="cell" data-sign="Aquarius">    <span class="sign-abbr" data-sign="Aquarius">Aq</span>    <span class="house-num"></span><div class="planets-area" data-sign="Aquarius"></div></div>
      <div class="cell-center"><span class="center-line" id="centerLine1">South Indian</span><span class="center-line" id="centerLine2">Chart</span></div>
      <div class="cell" data-sign="Cancer">      <span class="sign-abbr" data-sign="Cancer">Cn</span>      <span class="house-num"></span><div class="planets-area" data-sign="Cancer"></div></div>
      <div class="cell" data-sign="Capricorn">   <span class="sign-abbr" data-sign="Capricorn">Cp</span>   <span class="house-num"></span><div class="planets-area" data-sign="Capricorn"></div></div>
      <div class="cell" data-sign="Leo">         <span class="sign-abbr" data-sign="Leo">Le</span>         <span class="house-num"></span><div class="planets-area" data-sign="Leo"></div></div>
      <div class="cell" data-sign="Sagittarius"> <span class="sign-abbr" data-sign="Sagittarius">Sg</span> <span class="house-num"></span><div class="planets-area" data-sign="Sagittarius"></div></div>
      <div class="cell" data-sign="Scorpio">     <span class="sign-abbr" data-sign="Scorpio">Sc</span>     <span class="house-num"></span><div class="planets-area" data-sign="Scorpio"></div></div>
      <div class="cell" data-sign="Libra">       <span class="sign-abbr" data-sign="Libra">Li</span>       <span class="house-num"></span><div class="planets-area" data-sign="Libra"></div></div>
      <div class="cell" data-sign="Virgo">       <span class="sign-abbr" data-sign="Virgo">Vi</span>       <span class="house-num"></span><div class="planets-area" data-sign="Virgo"></div></div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title" id="bankTitle">Planet Bank ‚Äî Drag into chart</div>
    <div class="planet-bank" id="planetBank"></div>
    <div class="tip-box" id="bankTip">Drag planets into a sign. Tap a placed planet to set degree &amp; retrograde. Double-tap to return it to the bank.</div>
    <div class="btn-row">
      <button class="btn" id="btnSigns">Hide Signs</button>
      <button class="btn" id="btnNums">Hide Numbers</button>
      <button class="btn danger" id="btnClear">Clear Chart</button>
    </div>
    <div class="deg-hint" id="degHint">Tap placed planet ‚Üí set exact degree &amp; retrograde</div>
  </div>

  <div class="panel">
    <div class="tab-row">
      <button class="tab-btn active" data-tab="prompt">ü§ñ AI Prompt</button>
      <button class="tab-btn" data-tab="aspects">üî≠ Aspects</button>
    </div>
    <div class="tab-content active" id="tab-prompt" style="margin-top:12px">
      <div style="font-size:0.76rem;color:var(--text-dim);line-height:1.5;font-style:italic;margin-bottom:8px" id="promptIntro">Generate a ready-to-paste prompt for any AI (ChatGPT, Claude, Gemini‚Ä¶) to get a Vedic reading.</div>
      <div class="prompt-output" id="promptOutput"></div>
      <div class="btn-row" style="margin-top:8px">
        <button class="btn" id="btnGenPrompt">‚ú® Generate Prompt</button>
        <button class="btn" id="btnCopyPrompt">üìã Copy</button>
      </div>
    </div>
    <div class="tab-content" id="tab-aspects" style="margin-top:12px">
      <div id="aspectsPanel"><div class="empty-state">Place Lagna and planets to see special aspects (drishti)</div></div>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>
<div class="retro-panel" id="retroPanel">
  <div class="retro-panel-title" id="retroTitle">Planet</div>
  <label><input type="checkbox" id="retroCheck"><span id="retroLabel">Retrograde</span></label>
  <div class="deg-input-row">
    <span>Degree:</span>
    <input type="number" id="degInput" min="0" max="29.9" step="0.1" value="0" inputmode="decimal">
    <span>¬∞</span>
  </div>
  <span class="retro-panel-close" id="retroClose">Close</span>
</div>
<div class="sign-panel" id="signPanel">
  <strong id="spSignName"></strong>
  <hr>
  <div id="spBody"></div>
  <span class="sp-close" id="spClose">Close</span>
</div>

<script>
'use strict';

/* ‚îÄ‚îÄ Static data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const SIGNS = ["Aries","Taurus","Gemini","Cancer","Leo","Virgo",
               "Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"];
const ALL_PIDS = ['Lagna','Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn','Rahu','Ketu'];

const NAKSH = [
  {name:'Ashwini',           lord:'Ketu',    kw:'Speed, Healing, Initiative'},
  {name:'Bharani',           lord:'Venus',   kw:'Transformation, Patience, Sacrifice'},
  {name:'Krittika',          lord:'Sun',     kw:'Purification, Leadership, Protection'},
  {name:'Rohini',            lord:'Moon',    kw:'Growth, Fertility, Creativity'},
  {name:'Mrigashira',        lord:'Mars',    kw:'Curiosity, Searching, Wandering'},
  {name:'Ardra',             lord:'Rahu',    kw:'Transformation, Intensity, Renewal'},
  {name:'Punarvasu',         lord:'Jupiter', kw:'Renewal, Nourishment, Return'},
  {name:'Pushya',            lord:'Saturn',  kw:'Nourishment, Protection, Spirituality'},
  {name:'Ashlesha',          lord:'Mercury', kw:'Intuition, Hypnotic, Mysticism'},
  {name:'Magha',             lord:'Ketu',    kw:'Authority, Ancestors, Legacy'},
  {name:'Purva Phalguni',    lord:'Venus',   kw:'Enjoyment, Luxury, Romance'},
  {name:'Uttara Phalguni',   lord:'Sun',     kw:'Support, Union, Philanthropy'},
  {name:'Hasta',             lord:'Moon',    kw:'Skill, Dexterity, Craftsmanship'},
  {name:'Chitra',            lord:'Mars',    kw:'Artistry, Beauty, Architecture'},
  {name:'Swati',             lord:'Rahu',    kw:'Independence, Movement, Adaptability'},
  {name:'Vishakha',          lord:'Jupiter', kw:'Purpose, Determination, Achievement'},
  {name:'Anuradha',          lord:'Saturn',  kw:'Devotion, Friendship, Success'},
  {name:'Jyeshtha',          lord:'Mercury', kw:'Seniority, Protection, Power'},
  {name:'Moola',             lord:'Ketu',    kw:'Foundation, Destruction, Research'},
  {name:'Purva Ashadha',     lord:'Venus',   kw:'Invincibility, Persistence, Water'},
  {name:'Uttara Ashadha',    lord:'Sun',     kw:'Victory, Dharma, Leadership'},
  {name:'Shravana',          lord:'Moon',    kw:'Listening, Learning, Wisdom'},
  {name:'Dhanishta',         lord:'Mars',    kw:'Wealth, Rhythm, Celebration'},
  {name:'Shatabhisha',       lord:'Rahu',    kw:'Healing, Mysticism, Hidden Knowledge'},
  {name:'Purva Bhadrapada',  lord:'Jupiter', kw:'Transformation, Spiritual Fire'},
  {name:'Uttara Bhadrapada', lord:'Saturn',  kw:'Stability, Prosperity, Universal Love'},
  {name:'Revati',            lord:'Mercury', kw:'Nourishment, Protection, Completion'}
];

const PLANET_RULES = {
  Sun:['Leo'], Moon:['Cancer'], Mars:['Aries','Scorpio'],
  Mercury:['Gemini','Virgo'], Jupiter:['Sagittarius','Pisces'],
  Venus:['Taurus','Libra'], Saturn:['Capricorn','Aquarius'],
  Rahu:['Aquarius'], Ketu:['Scorpio']
};
const EXALTATION   = {Sun:'Aries',Moon:'Taurus',Mars:'Capricorn',Mercury:'Virgo',Jupiter:'Cancer',Venus:'Pisces',Saturn:'Libra',Rahu:'Taurus',Ketu:'Scorpio'};
const DEBILITATION = {Sun:'Libra',Moon:'Scorpio',Mars:'Cancer',Mercury:'Pisces',Jupiter:'Capricorn',Venus:'Virgo',Saturn:'Aries',Rahu:'Scorpio',Ketu:'Taurus'};

const SIGN_DATA = {
  Aries:       {kw:'Initiation, Action, Energy',            ruler:'Mars',          el:'Fire',  mod:'Cardinal', symbol:'‚ôà'},
  Taurus:      {kw:'Stability, Sensuality, Comfort',        ruler:'Venus',         el:'Earth', mod:'Fixed',    symbol:'‚ôâ'},
  Gemini:      {kw:'Communication, Intellect, Versatility', ruler:'Mercury',       el:'Air',   mod:'Dual',     symbol:'‚ôä'},
  Cancer:      {kw:'Nurturing, Emotion, Home',              ruler:'Moon',          el:'Water', mod:'Cardinal', symbol:'‚ôã'},
  Leo:         {kw:'Creativity, Leadership, Royalty',       ruler:'Sun',           el:'Fire',  mod:'Fixed',    symbol:'‚ôå'},
  Virgo:       {kw:'Service, Analysis, Health',             ruler:'Mercury',       el:'Earth', mod:'Dual',     symbol:'‚ôç'},
  Libra:       {kw:'Harmony, Relationships, Justice',       ruler:'Venus',         el:'Air',   mod:'Cardinal', symbol:'‚ôé'},
  Scorpio:     {kw:'Transformation, Secrecy, Intensity',    ruler:'Mars, Ketu',    el:'Water', mod:'Fixed',    symbol:'‚ôè'},
  Sagittarius: {kw:'Philosophy, Exploration, Wisdom',       ruler:'Jupiter',       el:'Fire',  mod:'Dual',     symbol:'‚ôê'},
  Capricorn:   {kw:'Discipline, Ambition, Structure',       ruler:'Saturn',        el:'Earth', mod:'Cardinal', symbol:'‚ôë'},
  Aquarius:    {kw:'Innovation, Humanitarianism',           ruler:'Saturn, Rahu',  el:'Air',   mod:'Fixed',    symbol:'‚ôí'},
  Pisces:      {kw:'Imagination, Spirituality, Compassion', ruler:'Jupiter, Ketu', el:'Water', mod:'Dual',     symbol:'‚ôì'}
};
const HOUSE_KW = {
  1:'Self, Personality, Body, Appearance, Health', 2:'Wealth, Family, Speech, Food, Values',
  3:'Siblings, Courage, Communication, Skills',    4:'Mother, Home, Land, Vehicles, Inner Peace',
  5:'Children, Creativity, Intelligence, Romance', 6:'Enemies, Debts, Disease, Service, Obstacles',
  7:'Marriage, Partnerships, Business, Spouse',    8:'Longevity, Occult, Inheritance, Transformation',
  9:'Father, Guru, Dharma, Fortune, Spirituality', 10:'Career, Status, Reputation, Authority',
  11:'Gains, Friends, Hopes, Community, Ambitions',12:'Losses, Expenses, Moksha, Foreign Lands'
};
// offset-from-planet's-house (1-based distances)
const SPECIAL_ASPECTS = {Mars:[4,7,8], Jupiter:[5,7,9], Saturn:[3,7,10], Rahu:[5,7,9], Ketu:[5,7,9]};

const TRANS = {
  en:{
    title:'South Indian Vedic Astrology Chart', subtitle:'Interactive ‚Ä¢ Drag planets into signs',
    bankTitle:'Planet Bank ‚Äî Drag into chart',
    bankTip:'Drag a planet into a sign. Tap once to set degree & retrograde. Double-tap to return to bank.',
    degHint:'Tap placed planet ‚Üí set exact degree & retrograde',
    hideSigns:'Hide Signs', showSigns:'Show Signs', hideNums:'Hide Numbers', showNums:'Show Numbers',
    clearChart:'Clear Chart', retroLabel:'Retrograde', close:'Close',
    nakshatra:'Nakshatra', pada:'Pada', house:'House', houseKw:'House Keywords', signKw:'Sign Keywords',
    ruler:'Ruler', element:'Element', modality:'Modality', lordOf:'Lord of', houseLord:'House Lordship',
    noLagna:'(Place Lagna to see house info)', center1:'South Indian', center2:'Chart',
    exalted:'Exalted', debilitated:'Debil.', ownSign:'Own',
    pnames:{Lagna:'Lagna',Sun:'Sun',Moon:'Moon',Mars:'Mars',Mercury:'Mercury',Jupiter:'Jupiter',Venus:'Venus',Saturn:'Saturn',Rahu:'Rahu',Ketu:'Ketu'},
    psym:{Lagna:'L',Sun:'Su',Moon:'Mo',Mars:'Ma',Mercury:'Me',Jupiter:'Ju',Venus:'Ve',Saturn:'Sa',Rahu:'Ra',Ketu:'Ke'},
    snames:{Aries:'Aries',Taurus:'Taurus',Gemini:'Gemini',Cancer:'Cancer',Leo:'Leo',Virgo:'Virgo',Libra:'Libra',Scorpio:'Scorpio',Sagittarius:'Sagittarius',Capricorn:'Capricorn',Aquarius:'Aquarius',Pisces:'Pisces'},
    ssym:{Aries:'Ar',Taurus:'Ta',Gemini:'Ge',Cancer:'Cn',Leo:'Le',Virgo:'Vi',Libra:'Li',Scorpio:'Sc',Sagittarius:'Sg',Capricorn:'Cp',Aquarius:'Aq',Pisces:'Pi'},
    hn:{1:'1st House',2:'2nd House',3:'3rd House',4:'4th House',5:'5th House',6:'6th House',7:'7th House',8:'8th House',9:'9th House',10:'10th House',11:'11th House',12:'12th House'}
  },
  te:{
    title:'‡∞¶‡∞ï‡±ç‡∞∑‡∞ø‡∞£ ‡∞≠‡∞æ‡∞∞‡∞§‡±Ä‡∞Ø ‡∞µ‡±á‡∞¶ ‡∞ú‡±ç‡∞Ø‡±ã‡∞§‡∞ø‡∞∑‡±ç‡∞Ø ‡∞ö‡∞æ‡∞∞‡±ç‡∞ü‡±ç', subtitle:'‡∞á‡∞Ç‡∞ü‡∞∞‡∞æ‡∞ï‡±ç‡∞ü‡∞ø‡∞µ‡±ç ‚Ä¢ ‡∞ó‡±ç‡∞∞‡∞π‡∞æ‡∞≤‡∞®‡±Å ‡∞∞‡∞æ‡∞∂‡±Å‡∞≤‡∞≤‡±ã ‡∞â‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø',
    bankTitle:'‡∞ó‡±ç‡∞∞‡∞π ‡∞¨‡±ç‡∞Ø‡∞æ‡∞Ç‡∞ï‡±ç ‚Äî ‡∞ö‡∞æ‡∞∞‡±ç‡∞ü‡±ç‚Äå‡∞≤‡±ã‡∞ï‡∞ø ‡∞≤‡∞æ‡∞ó‡∞Ç‡∞°‡∞ø',
    bankTip:'‡∞ó‡±ç‡∞∞‡∞π‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞∞‡∞æ‡∞∂‡∞ø‡∞≤‡±ã‡∞ï‡∞ø ‡∞≤‡∞æ‡∞ó‡∞Ç‡∞°‡∞ø. ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø ‡∞°‡∞ø‡∞ó‡±ç‡∞∞‡±Ä/‡∞µ‡∞ï‡±ç‡∞∞‡∞ø ‡∞∏‡±Ü‡∞ü‡±ç ‡∞ö‡±á‡∞Ø‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø. ‡∞∞‡±Ü‡∞Ç‡∞°‡±Å‡∞∏‡∞æ‡∞∞‡±ç‡∞≤‡±Å ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞ø ‡∞§‡∞ø‡∞∞‡∞ø‡∞ó‡∞ø ‡∞™‡∞Ç‡∞™‡∞Ç‡∞°‡∞ø.',
    degHint:'‡∞ó‡±ç‡∞∞‡∞π‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞ø ‡∞°‡∞ø‡∞ó‡±ç‡∞∞‡±Ä & ‡∞µ‡∞ï‡±ç‡∞∞‡∞ø ‡∞∏‡±Ü‡∞ü‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø',
    hideSigns:'‡∞∞‡∞æ‡∞∂‡±Å‡∞≤‡∞®‡±Å ‡∞¶‡∞æ‡∞ö‡±Å', showSigns:'‡∞∞‡∞æ‡∞∂‡±Å‡∞≤‡∞®‡±Å ‡∞ö‡±Ç‡∞™‡±Å', hideNums:'‡∞®‡∞Ç‡∞¨‡∞∞‡±ç‡∞≤‡∞®‡±Å ‡∞¶‡∞æ‡∞ö‡±Å', showNums:'‡∞®‡∞Ç‡∞¨‡∞∞‡±ç‡∞≤‡∞®‡±Å ‡∞ö‡±Ç‡∞™‡±Å',
    clearChart:'‡∞ö‡∞æ‡∞∞‡±ç‡∞ü‡±ç ‡∞ï‡±ç‡∞≤‡∞ø‡∞Ø‡∞∞‡±ç', retroLabel:'‡∞µ‡∞ï‡±ç‡∞∞‡∞ø', close:'‡∞Æ‡±Ç‡∞∏‡∞ø‡∞µ‡±á‡∞Ø‡∞ø',
    nakshatra:'‡∞®‡∞ï‡±ç‡∞∑‡∞§‡±ç‡∞∞‡∞Ç', pada:'‡∞™‡∞æ‡∞¶', house:'‡∞á‡∞≤‡±ç‡∞≤‡±Å', houseKw:'‡∞á‡∞Ç‡∞ü‡∞ø ‡∞ï‡±Ä‡∞µ‡∞∞‡±ç‡∞°‡±ç‡∞∏‡±ç', signKw:'‡∞∞‡∞æ‡∞∂‡∞ø ‡∞ï‡±Ä‡∞µ‡∞∞‡±ç‡∞°‡±ç‡∞∏‡±ç',
    ruler:'‡∞™‡∞æ‡∞≤‡∞ï ‡∞ó‡±ç‡∞∞‡∞π‡∞Ç', element:'‡∞Æ‡±Ç‡∞≤‡∞ï‡∞Ç', modality:'‡∞Æ‡±ã‡∞°‡∞æ‡∞≤‡∞ø‡∞ü‡±Ä', lordOf:'‡∞Ö‡∞ß‡∞ø‡∞™‡∞§‡∞ø', houseLord:'‡∞á‡∞Ç‡∞ü‡∞ø ‡∞Ü‡∞ß‡∞ø‡∞™‡∞§‡±ç‡∞Ø‡∞Ç',
    noLagna:'(‡∞á‡∞Ç‡∞ü‡∞ø ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç ‡∞ö‡±Ç‡∞°‡∞ü‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞≤‡∞ó‡±ç‡∞®‡∞æ‡∞®‡∞ø ‡∞â‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø)', center1:'‡∞¶‡∞ï‡±ç‡∞∑‡∞ø‡∞£ ‡∞≠‡∞æ‡∞∞‡∞§‡±Ä‡∞Ø', center2:'‡∞ö‡∞æ‡∞∞‡±ç‡∞ü‡±ç',
    exalted:'‡∞â‡∞ö‡±ç‡∞ö', debilitated:'‡∞®‡±Ä‡∞ö', ownSign:'‡∞∏‡±ç‡∞µ',
    pnames:{Lagna:'‡∞≤‡∞ó‡±ç‡∞®',Sun:'‡∞∏‡±Ç‡∞∞‡±ç‡∞Ø‡±Å‡∞°‡±Å',Moon:'‡∞ö‡∞Ç‡∞¶‡±ç‡∞∞‡±Å‡∞°‡±Å',Mars:'‡∞ï‡±Å‡∞ú‡±Å‡∞°‡±Å',Mercury:'‡∞¨‡±Å‡∞ß‡±Å‡∞°‡±Å',Jupiter:'‡∞ó‡±Å‡∞∞‡±Å‡∞°‡±Å',Venus:'‡∞∂‡±Å‡∞ï‡±ç‡∞∞‡±Å‡∞°‡±Å',Saturn:'‡∞∂‡∞®‡∞ø',Rahu:'‡∞∞‡∞æ‡∞π‡±Å‡∞µ‡±Å',Ketu:'‡∞ï‡±á‡∞§‡±Å‡∞µ‡±Å'},
    psym:{Lagna:'‡∞≤',Sun:'‡∞∏‡±Ç',Moon:'‡∞ö‡∞Ç',Mars:'‡∞ï‡±Å',Mercury:'‡∞¨‡±Å',Jupiter:'‡∞ó‡±Å',Venus:'‡∞∂‡±Å',Saturn:'‡∞∂',Rahu:'‡∞∞‡∞æ',Ketu:'‡∞ï‡±á'},
    snames:{Aries:'‡∞Æ‡±á‡∞∑‡∞Ç',Taurus:'‡∞µ‡±É‡∞∑‡∞≠‡∞Ç',Gemini:'‡∞Æ‡∞ø‡∞•‡±Å‡∞®‡∞Ç',Cancer:'‡∞ï‡∞∞‡±ç‡∞ï‡∞æ‡∞ü‡∞ï‡∞Ç',Leo:'‡∞∏‡∞ø‡∞Ç‡∞π‡∞Ç',Virgo:'‡∞ï‡∞®‡±ç‡∞Ø',Libra:'‡∞§‡±Å‡∞≤',Scorpio:'‡∞µ‡±É‡∞∂‡±ç‡∞ö‡∞ø‡∞ï‡∞Ç',Sagittarius:'‡∞ß‡∞®‡±Å‡∞∏‡±ç‡∞∏‡±Å',Capricorn:'‡∞Æ‡∞ï‡∞∞‡∞Ç',Aquarius:'‡∞ï‡±Å‡∞Ç‡∞≠‡∞Ç',Pisces:'‡∞Æ‡±Ä‡∞®‡∞Ç'},
    ssym:{Aries:'‡∞Æ‡±á',Taurus:'‡∞µ‡±É',Gemini:'‡∞Æ‡∞ø',Cancer:'‡∞ï',Leo:'‡∞∏‡∞ø‡∞Ç',Virgo:'‡∞ï‡∞®‡±ç‡∞Ø',Libra:'‡∞§‡±Å',Scorpio:'‡∞µ‡±É‡∞∂‡±ç‡∞ö‡∞ø',Sagittarius:'‡∞ß‡∞®‡±Å',Capricorn:'‡∞Æ‡∞ï',Aquarius:'‡∞ï‡±Å‡∞Ç',Pisces:'‡∞Æ‡±Ä'},
    hn:{1:'1‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',2:'2‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',3:'3‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',4:'4‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',5:'5‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',6:'6‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',7:'7‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',8:'8‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',9:'9‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',10:'10‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',11:'11‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å',12:'12‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å'}
  }
};

/* ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let lang        = 'en';
let lagnaSign   = null;         // single source of truth
let signsHidden = false;
let numsHidden  = false;
let planetData  = {};           // pid ‚Üí {sign, degree, retro}
let activePid   = null;
let dragState   = null;
let lastPtrUpTime = 0;

const isTouch = () => window.matchMedia('(hover:none)').matches;

/* ‚îÄ‚îÄ Cached DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const $  = id  => document.getElementById(id);
const $q = sel => document.querySelector(sel);
const $a = sel => document.querySelectorAll(sel);
const ghost      = $('drag-ghost');
const tooltip    = $('tooltip');
const retroPanel = $('retroPanel');
const retroCheck = $('retroCheck');
const retroTitle = $('retroTitle');
const degInput   = $('degInput');
const signPanel  = $('signPanel');
const overlay    = $('overlay');

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const T = () => TRANS[lang];

function houseNum(sign, ls) {
  const lagna = ls !== undefined ? ls : lagnaSign;
  if (!lagna) return null;
  return (SIGNS.indexOf(sign) - SIGNS.indexOf(lagna) + 12) % 12 + 1;
}

function getNakshatra(sign, deg) {
  const si = SIGNS.indexOf(sign);
  if (si < 0) return {name:'?', kw:'', pada:1, lord:'?'};
  const total = si * 30 + Math.max(0, Math.min(29.9, deg));
  const nLen  = 360 / 27;
  const ni    = Math.min(26, Math.floor(total / nLen));
  const pada  = Math.min(4, Math.floor((total % nLen) / (nLen / 4)) + 1);
  return {...NAKSH[ni], pada};
}

function getStrength(pid, sign) {
  if (!pid || pid === 'Lagna') return null;
  if (EXALTATION[pid]   === sign) return 'exalted';
  if (DEBILITATION[pid] === sign) return 'debilitated';
  if ((PLANET_RULES[pid] || []).includes(sign)) return 'own';
  return null;
}

function clampDeg(v) {
  return Math.round(Math.max(0, Math.min(29.9, parseFloat(v) || 0)) * 10) / 10;
}

/* ‚îÄ‚îÄ Planet elements ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function buildPlanet(pid) {
  const el = document.createElement('span');
  el.className = `planet ${pid}`;
  el.dataset.pid = pid;
  refreshPlanetContent(el);
  return el;
}

function refreshPlanetContent(el) {
  const pid = el.dataset.pid;
  const d   = planetData[pid];
  let html  = T().psym[pid] || pid.slice(0,2);
  if (d) {
    html += `<span class="deg-label">${d.degree.toFixed(1)}¬∞</span>`;
    if (d.retro) html += `<span class="retro-mark">R</span>`;
  }
  el.innerHTML = html;
}

function refreshAllPlanets() {
  document.querySelectorAll('.planet').forEach(el => refreshPlanetContent(el));
}

/* ‚îÄ‚îÄ Bank rebuild ‚Äî no duplicates, correct order ‚îÄ */
function rebuildBank() {
  const bank    = $('planetBank');
  const inChart = new Set([...$a('.planets-area .planet')].map(e => e.dataset.pid));
  bank.innerHTML = '';
  ALL_PIDS.forEach(pid => { if (!inChart.has(pid)) bank.appendChild(buildPlanet(pid)); });
}

/* ‚îÄ‚îÄ House numbers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function updateHouseNums() {
  $a('.cell[data-sign]').forEach(cell => {
    const span = cell.querySelector('.house-num');
    if (!span) return;
    const n = houseNum(cell.dataset.sign);
    span.textContent = (n && !numsHidden) ? n : '';
  });
}

/* ‚îÄ‚îÄ Sign labels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function updateSignLabels() {
  const t = T();
  $a('.sign-abbr').forEach(el => {
    el.textContent = t.ssym[el.dataset.sign] || el.dataset.sign.slice(0,2);
    el.classList.toggle('hidden-label', signsHidden);
  });
}

/* ‚îÄ‚îÄ Aspects ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function updateAspects() {
  const panel  = $('aspectsPanel');
  const placed = ALL_PIDS.filter(p => p !== 'Lagna' && planetData[p]);
  if (!lagnaSign || placed.length < 1) {
    panel.innerHTML = `<div class="empty-state">Place Lagna and planets to see special aspects (drishti)</div>`;
    return;
  }
  const t    = T();
  const rows = [];

  placed.forEach(pid => {
    if (!SPECIAL_ASPECTS[pid]) return;
    const fromH = houseNum(planetData[pid].sign);
    if (!fromH) return;
    SPECIAL_ASPECTS[pid].forEach(offset => {
      const toH    = (fromH - 1 + offset - 1) % 12 + 1;
      const toSign = SIGNS.find(s => houseNum(s) === toH);
      if (!toSign) return;
      const targets = placed.filter(p2 => p2 !== pid && planetData[p2]?.sign === toSign);
      const chip = p => `<span class="planet ${p}" style="pointer-events:none;transform:none;box-shadow:none;font-size:0.6rem;padding:2px 5px;min-height:auto">${t.psym[p]}</span>`;
      if (targets.length === 0) {
        rows.push(`<div class="aspect-entry">${chip(pid)}<span style="color:var(--accent)">‚Üí</span><span style="color:var(--text-muted)">H${toH} (${t.snames[toSign]}) ‚Äî empty</span></div>`);
      } else {
        targets.forEach(p2 => {
          rows.push(`<div class="aspect-entry">${chip(pid)}<span style="color:var(--accent)">‚Üí</span>${chip(p2)}<span style="color:var(--text-dim)">${t.pnames[pid]} aspects ${t.pnames[p2]} (H${toH})</span></div>`);
        });
      }
    });
  });

  panel.innerHTML = rows.length
    ? `<div style="font-family:'Cinzel',serif;font-size:0.68rem;color:var(--text-muted);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:8px">Special Aspects (Drishti)</div>` + rows.join('')
    : `<div class="empty-state">No special aspects found between placed planets</div>`;
}

/* ‚îÄ‚îÄ AI Prompt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function generatePrompt() {
  const t      = T();
  const placed = ALL_PIDS.filter(p => planetData[p]);
  const out    = $('promptOutput');
  if (placed.length === 0) { out.textContent = ''; return; }

  const lagnaInfo = planetData['Lagna'];
  const lagnaLine = lagnaInfo
    ? `Lagna (Ascendant): ${lagnaInfo.sign} (${lagnaInfo.degree.toFixed(2)}¬∞)`
    : 'Lagna: Not placed';

  const lines = ALL_PIDS.filter(p => p !== 'Lagna' && planetData[p]).map(pid => {
    const d        = planetData[pid];
    const nak      = getNakshatra(d.sign, d.degree);
    const hn       = lagnaSign ? houseNum(d.sign) : null;
    const strength = getStrength(pid, d.sign);
    let line = `${t.pnames[pid]}: ${d.sign} at ${d.degree.toFixed(2)}¬∞ ‚Äî ${nak.name} (Pada ${nak.pada}, Lord: ${nak.lord})`;
    if (hn)       line += `, ${t.hn[hn]}`;
    if (strength) line += ` [${strength==='exalted'?'EXALTED':strength==='debilitated'?'DEBILITATED':'Own Sign'}]`;
    if (d.retro)  line += ' ‚Ñû (Retrograde)';
    return line;
  });

  out.textContent =
`I have a South Indian Vedic (Jyotisha) natal chart. Please analyse using classical Vedic astrology (Parashari system).

‚ïê‚ïê‚ïê CHART ‚ïê‚ïê‚ïê
${lagnaLine}

${lines.join('\n')}

‚ïê‚ïê‚ïê REQUEST ‚ïê‚ïê‚ïê
Please provide a comprehensive reading covering personality, health, career, finances, relationships, family, spirituality, and life purpose. Discuss planetary strengths, house lordships, conjunctions, and special aspects. Use traditional Vedic methods (not Western/Tropical).`;
}

/* ‚îÄ‚îÄ Language / UI refresh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function applyLang() {
  const t = T();
  $('appTitle').textContent    = t.title;
  $('appSubtitle').textContent = t.subtitle;
  $('bankTitle').textContent   = t.bankTitle;
  $('bankTip').textContent     = t.bankTip;
  $('degHint').textContent     = t.degHint;
  $('centerLine1').textContent = t.center1;
  $('centerLine2').textContent = t.center2;
  $('retroLabel').textContent  = t.retroLabel;
  $('retroClose').textContent  = t.close;
  $('spClose').textContent     = t.close;
  $('btnSigns').textContent    = signsHidden ? t.showSigns : t.hideSigns;
  $('btnNums').textContent     = numsHidden  ? t.showNums  : t.hideNums;
  $('btnClear').textContent    = t.clearChart;
  updateSignLabels();
  updateHouseNums();
  refreshAllPlanets();
}

/* ‚îÄ‚îÄ Tooltip (desktop only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function showTooltip(pid, x, y) {
  const t = T(), d = planetData[pid];
  if (!d) return;
  const nak      = getNakshatra(d.sign, d.degree);
  const strength = getStrength(pid, d.sign);
  const sl = {exalted:t.exalted, debilitated:t.debilitated, own:t.ownSign};
  const sc = {exalted:'var(--green)', debilitated:'var(--red)', own:'var(--gold)'};
  let html = `<strong>${t.pnames[pid]||pid}</strong>`;
  html += `<div class="trow">${d.degree.toFixed(2)}¬∞ ${t.snames[d.sign]||d.sign}</div>`;
  html += `<div class="trow"><span>${t.nakshatra}:</span> ${nak.name} (Lord: ${nak.lord})</div>`;
  html += `<div class="trow"><span>Keywords:</span> ${nak.kw}</div>`;
  html += `<div class="trow"><span>${t.pada}:</span> ${nak.pada}</div>`;
  if (strength) html += `<div class="trow" style="color:${sc[strength]}">‚¨• ${sl[strength]}</div>`;
  if (d.retro)  html += `<div class="trow" style="color:var(--red)">(${t.retroLabel})</div>`;
  if (lagnaSign && PLANET_RULES[pid]) {
    html += `<hr><div style="color:var(--gold);font-family:'Cinzel',serif;font-size:0.7rem;margin-bottom:2px">${t.houseLord}</div>`;
    PLANET_RULES[pid].forEach(rs => {
      const hn = houseNum(rs);
      if (!hn) return;
      html += `<div class="trow">${t.lordOf} ${t.hn[hn]}: <span>${(HOUSE_KW[hn]||'').split(',').slice(0,2).join(',')}</span></div>`;
    });
  }
  tooltip.innerHTML = html;
  tooltip.classList.add('visible');
  positionPopup(tooltip, x, y);
}
function hideTooltip() { tooltip.classList.remove('visible'); }

/* ‚îÄ‚îÄ Popup positioning (safe viewport) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function positionPopup(el, x, y) {
  el.style.left = '-9999px'; el.style.top = '-9999px';
  const vw = window.innerWidth, vh = window.innerHeight;
  const w  = el.offsetWidth  || 200;
  const h  = el.offsetHeight || 100;
  let lx = x + 16, ly = y - h - 12;
  if (lx + w > vw - 8) lx = x - w - 16;
  if (lx < 8)          lx = 8;
  if (ly < 8)          ly = y + 24;
  if (ly + h > vh - 8) ly = vh - h - 8;
  el.style.left = lx + 'px';
  el.style.top  = ly + 'px';
}

/* ‚îÄ‚îÄ Sign Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function showSignPanel(sign, x, y) {
  hideAllPanels();
  const t = T(), sd = SIGN_DATA[sign], hn = houseNum(sign);
  $('spSignName').textContent = `${sd?.symbol||''} ${t.snames[sign]||sign}`;
  let body = hn
    ? `<div><strong>${t.house}:</strong> ${t.hn[hn]}</div><div><strong>${t.houseKw}:</strong> ${HOUSE_KW[hn]}</div><hr>`
    : `<div style="color:var(--text-muted);font-style:italic">${t.noLagna}</div><hr>`;
  if (sd) {
    body += `<div><strong>${t.signKw}:</strong> ${sd.kw}</div>`;
    body += `<div><strong>${t.ruler}:</strong> ${sd.ruler} &nbsp;|&nbsp; <strong>${t.element}:</strong> ${sd.el} &nbsp;|&nbsp; <strong>${t.modality}:</strong> ${sd.mod}</div>`;
  }
  $('spBody').innerHTML = body;
  signPanel.classList.add('visible');
  overlay.classList.add('visible');
  positionPopup(signPanel, x, y);
}

/* ‚îÄ‚îÄ Retro Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function showRetroPanel(pid, x, y) {
  hideAllPanels();
  activePid = pid;
  retroTitle.textContent = T().pnames[pid] || pid;
  retroCheck.checked = !!(planetData[pid]?.retro);
  degInput.value     = planetData[pid]?.degree?.toFixed(1) ?? '0';
  retroPanel.classList.add('visible');
  overlay.classList.add('visible');
  positionPopup(retroPanel, x, y);
}

function hideAllPanels() {
  hideTooltip();
  signPanel.classList.remove('visible');
  retroPanel.classList.remove('visible');
  overlay.classList.remove('visible');
  activePid = null;
}

retroCheck.addEventListener('change', () => {
  if (!activePid || !planetData[activePid]) return;
  planetData[activePid].retro = retroCheck.checked;
  const el = $q(`.planets-area .planet[data-pid="${activePid}"]`);
  if (el) refreshPlanetContent(el);
});

degInput.addEventListener('input', () => {
  if (!activePid || !planetData[activePid]) return;
  planetData[activePid].degree = clampDeg(degInput.value);
  const el = $q(`.planets-area .planet[data-pid="${activePid}"]`);
  if (el) refreshPlanetContent(el);
});

degInput.addEventListener('blur', () => {
  if (activePid && planetData[activePid])
    degInput.value = planetData[activePid].degree.toFixed(1);
});

$('retroClose').addEventListener('click', hideAllPanels);
$('spClose').addEventListener('click', hideAllPanels);
overlay.addEventListener('click', hideAllPanels);

/* ‚îÄ‚îÄ Move planet into sign ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function movePlanetToSign(pid, targetSign) {
  // remove from current location (bank or another cell)
  const existing = $q(`.planet[data-pid="${pid}"]`);
  if (existing) existing.remove();

  // update state
  if (!planetData[pid]) {
    planetData[pid] = {sign:targetSign, degree:Math.round(Math.random()*299)/10, retro:false};
  } else {
    planetData[pid].sign = targetSign;
  }
  if (pid === 'Lagna') lagnaSign = targetSign;

  // place in chart
  const area = $q(`.planets-area[data-sign="${targetSign}"]`);
  if (area) area.appendChild(buildPlanet(pid));

  // house nums update immediately after lagna is set
  updateHouseNums();
  updateAspects();
}

/* ‚îÄ‚îÄ Return planet to bank ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function returnPlanetToBank(pid) {
  const existing = $q(`.planets-area .planet[data-pid="${pid}"]`);
  if (!existing) return;
  existing.remove();
  delete planetData[pid];
  if (pid === 'Lagna') { lagnaSign = null; updateHouseNums(); }
  rebuildBank();   // full rebuild = correct order, no dupes
  updateAspects();
}

/* ‚îÄ‚îÄ Drag & Drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.addEventListener('pointerdown',  onPtrDown,   {passive:false});
document.addEventListener('pointermove',  onPtrMove,   {passive:false});
document.addEventListener('pointerup',    onPtrUp,     {passive:false});
document.addEventListener('pointercancel', onPtrCancel);

function onPtrDown(e) {
  if (dragState) return;
  const planetEl = e.target.closest('.planet');
  if (!planetEl) return;
  const inChart = !!planetEl.closest('.planets-area');
  const inBank  = !!planetEl.closest('#planetBank');
  if (!inChart && !inBank) return;
  e.preventDefault();
  dragState = {
    pid: planetEl.dataset.pid, pointerId: e.pointerId, sourceEl: planetEl,
    startX: e.clientX, startY: e.clientY,
    moved:false, isDegMode:false, dirLocked:false, initDeg:0, inChart, ghostShown:false
  };
}

function onPtrMove(e) {
  if (!dragState || e.pointerId !== dragState.pointerId) return;
  e.preventDefault();
  const dx   = e.clientX - dragState.startX;
  const dy   = e.clientY - dragState.startY;
  if (Math.hypot(dx, dy) < 6) return;
  dragState.moved = true;

  // lock direction on first significant move (from chart only)
  if (dragState.inChart && !dragState.dirLocked) {
    dragState.isDegMode  = Math.abs(dy) > Math.abs(dx) * 1.4;
    dragState.dirLocked  = true;
    dragState.initDeg    = planetData[dragState.pid]?.degree ?? 0;
  }

  if (dragState.isDegMode) {
    const v = clampDeg(dragState.initDeg + (dragState.startY - e.clientY) / 20);
    if (planetData[dragState.pid]) {
      planetData[dragState.pid].degree = v;
      refreshPlanetContent(dragState.sourceEl);
      if (!isTouch()) showTooltip(dragState.pid, e.clientX, e.clientY);
    }
    return;
  }

  if (!dragState.ghostShown) {
    dragState.ghostShown = true;
    dragState.sourceEl.classList.add('dragging');
    dragState.sourceEl.style.pointerEvents = 'none';
    hideAllPanels();
    const inner = dragState.sourceEl.cloneNode(true);
    inner.style.cssText += ';transform:none;pointer-events:none;';
    ghost.innerHTML = '';
    ghost.appendChild(inner);
    ghost.style.display = 'block';
  }
  const gw = ghost.offsetWidth || 44, gh = ghost.offsetHeight || 26;
  ghost.style.left = (e.clientX - gw/2) + 'px';
  ghost.style.top  = (e.clientY - gh/2) + 'px';
  $a('.cell.drop-active,.planet-bank.drop-active').forEach(el => el.classList.remove('drop-active'));
  const under = getDropTarget(e.clientX, e.clientY);
  if (under) under.classList.add('drop-active');
}

function onPtrUp(e) {
  if (!dragState || e.pointerId !== dragState.pointerId) return;
  e.preventDefault();
  cleanDrag();
  const {pid, moved, isDegMode, inChart} = dragState;

  if (!moved) {
    if (inChart && planetData[pid]) {
      // brief flash, then show panel
      const el = $q(`.planets-area .planet[data-pid="${pid}"]`);
      if (el) { el.classList.add('tap-flash'); setTimeout(()=>el.classList.remove('tap-flash'),180); }
      showRetroPanel(pid, e.clientX, e.clientY);
    }
    dragState = null; return;
  }
  if (isDegMode) { dragState = null; return; }

  lastPtrUpTime = Date.now();
  const under = getDropTarget(e.clientX, e.clientY);
  if (under) {
    if (under.id === 'planetBank') returnPlanetToBank(pid);
    else if (under.dataset.sign)  movePlanetToSign(pid, under.dataset.sign);
  }
  dragState = null;
}

function onPtrCancel(e) {
  if (!dragState || e.pointerId !== dragState.pointerId) return;
  cleanDrag(); dragState = null; hideTooltip();
}

function cleanDrag() {
  ghost.style.display = 'none'; ghost.innerHTML = '';
  $a('.cell.drop-active,.planet-bank.drop-active').forEach(el=>el.classList.remove('drop-active'));
  if (dragState?.sourceEl) {
    dragState.sourceEl.classList.remove('dragging');
    dragState.sourceEl.style.pointerEvents = '';
  }
  hideTooltip();
}

function getDropTarget(x, y) {
  for (const el of document.elementsFromPoint(x, y)) {
    const cell = el.closest('.cell[data-sign]');
    if (cell) return cell;
    if (el.id === 'planetBank' || el.closest('#planetBank')) return $('planetBank');
  }
  return null;
}

/* ‚îÄ‚îÄ Double-tap ‚Üí return to bank ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let lastTap = {pid:null, time:0};
document.addEventListener('click', e => {
  if (Date.now() - lastPtrUpTime < 300) return;
  const planetEl = e.target.closest('.planet');
  if (!planetEl || !planetEl.closest('.planets-area')) return;
  const pid = planetEl.dataset.pid, now = Date.now();
  if (lastTap.pid === pid && now - lastTap.time < 500) {
    returnPlanetToBank(pid); hideAllPanels(); lastTap = {pid:null, time:0};
  } else { lastTap = {pid, time:now}; }
});

/* ‚îÄ‚îÄ Sign label tap / hover ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
$a('.sign-abbr').forEach(abbr => {
  abbr.addEventListener('click', ev => {
    ev.stopPropagation();
    if (!signsHidden) showSignPanel(abbr.dataset.sign, ev.clientX, ev.clientY);
  });
  abbr.addEventListener('mouseenter', ev => {
    if (!signsHidden && !isTouch()) showSignPanel(abbr.dataset.sign, ev.clientX, ev.clientY);
  });
});

/* ‚îÄ‚îÄ Desktop hover tooltip ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.addEventListener('mousemove', e => {
  if (dragState || isTouch()) return;
  const planetEl = e.target.closest('.planet');
  if (planetEl && planetEl.closest('.planets-area') && planetData[planetEl.dataset.pid]) {
    showTooltip(planetEl.dataset.pid, e.clientX, e.clientY);
  } else if (!e.target.closest('#tooltip')) { hideTooltip(); }
});

/* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
$a('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    $a('.tab-btn').forEach(b=>b.classList.remove('active'));
    $a('.tab-content').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    const id = btn.dataset.tab;
    $('tab-'+id).classList.add('active');
    if (id==='aspects') updateAspects();
    if (id==='prompt')  generatePrompt();
  });
});

/* ‚îÄ‚îÄ Prompt buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
$('btnGenPrompt').addEventListener('click', generatePrompt);
$('btnCopyPrompt').addEventListener('click', () => {
  const text = $('promptOutput').textContent;
  if (!text) return;
  const toast = () => { $('copyToast').classList.add('show'); setTimeout(()=>$('copyToast').classList.remove('show'),2200); };
  if (navigator.clipboard?.writeText) navigator.clipboard.writeText(text).then(toast).catch(()=>fallbackCopy(text,toast));
  else fallbackCopy(text, toast);
});
function fallbackCopy(text, cb) {
  try {
    const ta = Object.assign(document.createElement('textarea'), {value:text, style:'position:fixed;opacity:0'});
    document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); cb();
  } catch(_){}
}

/* ‚îÄ‚îÄ Control buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
$('btnSigns').addEventListener('click', () => {
  signsHidden = !signsHidden;
  $('btnSigns').textContent = signsHidden ? T().showSigns : T().hideSigns;
  updateSignLabels();
});
$('btnNums').addEventListener('click', () => {
  numsHidden = !numsHidden;
  $('btnNums').textContent = numsHidden ? T().showNums : T().hideNums;
  updateHouseNums();
});
$('btnClear').addEventListener('click', () => {
  $a('.planets-area .planet').forEach(el=>el.remove());
  planetData = {}; lagnaSign = null; signsHidden = false; numsHidden = false;
  dragState = null; ghost.style.display = 'none';
  rebuildBank(); applyLang(); updateAspects();
  $('promptOutput').textContent = '';
  hideAllPanels();
});
$('lang').addEventListener('change', e => { lang = e.target.value; applyLang(); hideAllPanels(); });

/* ‚îÄ‚îÄ Close panels on outside tap ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.addEventListener('pointerdown', e => {
  if (!retroPanel.classList.contains('visible') && !signPanel.classList.contains('visible')) return;
  if (e.target.closest('#retroPanel') || e.target.closest('#signPanel') || e.target.closest('.sign-abbr')) return;
  hideAllPanels();
}, {capture:true});

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
rebuildBank();    // build bank cleanly from scratch
applyLang();      // labels, sign abbrs, house nums
updateAspects();  // initial empty state
</script>
</body>
</html>
